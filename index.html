<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Intramural Scouting v6.3 (Pause Menu)</title>
    <style>
        :root { --blue: #3b82f6; --red: #ef4444; --dark: #0f172a; --panel: #18181b; --text: #f8fafc; }
        body { margin: 0; background: #000; color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; user-select: none; }
        
        /* UI LAYOUT */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; }
        .screen.active { display: flex; animation: fade 0.3s ease-out; }
        @keyframes fade { from {opacity:0} to {opacity:1} }

        /* MENU STYLES */
        #screen-menu { background: linear-gradient(135deg, #0f172a 0%, #000 100%); align-items: center; justify-content: center; }
        .hero-title { font-size: 60px; font-weight: 900; margin-bottom: 20px; text-align: center; text-transform: uppercase; letter-spacing: -2px; }
        .menu-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 15px 50px; font-size: 18px; font-weight: bold; margin: 10px; cursor: pointer; transition: 0.2s; width: 300px; text-transform: uppercase; }
        .menu-btn:hover { background: white; color: black; }
        .menu-btn.primary { background: var(--blue); border-color: var(--blue); }

        /* GM DASHBOARD */
        #screen-gm { background: #111; flex-direction: row; }
        .gm-sidebar { width: 280px; background: #0f1115; border-right: 1px solid #222; padding: 20px; display: flex; flex-direction: column; }
        .gm-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; gap: 30px; }
        .team-card { padding: 10px; background: #1f1f23; border: 1px solid #333; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .team-card:hover { border-color: #666; }
        .team-card.active { border-color: var(--blue); background: #252530; }
        .color-dot { width: 10px; height: 10px; border-radius: 50%; }
        
        /* EDITOR */
        .editor-panel { width: 450px; background: #18181b; padding: 20px; border-radius: 8px; border: 1px solid #333; display: none; }
        .editor-panel.active { display: block; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        label { display: block; font-size: 10px; color: #888; text-transform: uppercase; font-weight: bold; margin-bottom: 2px; }
        input[type=text], input[type=number] { background: #000; border: 1px solid #333; color: white; padding: 5px; width: 100%; box-sizing: border-box; }
        input[type=color] { width: 100%; height: 30px; border: none; background: none; }
        input[type=range] { width: 100%; accent-color: var(--blue); }

        /* GAME HUD */
        #screen-game { background: #000; }
        .hud-top { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 40px; background: rgba(0,0,0,0.8); padding: 10px 40px; border-radius: 10px; border-bottom: 3px solid var(--blue); z-index: 50; }
        .score-box { text-align: center; }
        .score-lbl { font-size: 10px; color: #aaa; font-weight: bold; }
        .score-num { font-size: 30px; font-weight: 900; font-family: monospace; line-height: 1; }
        
        .controls-hint { position: absolute; bottom: 20px; left: 20px; font-size: 12px; color: #ccc; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; line-height: 1.6; border-left: 3px solid var(--blue); }
        .feedback { position: absolute; top: 150px; left: 50%; transform: translateX(-50%); font-size: 40px; font-weight: 900; color: #fbbf24; text-shadow: 0 4px 10px black; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 40; }
        
        .pause-btn { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; background: rgba(0,0,0,0.8); border: 1px solid #333; color: white; font-weight: bold; border-radius: 50%; cursor: pointer; z-index: 100; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .pause-btn:hover { background: #333; }

        /* PAUSE MENU OVERLAY */
        .pause-menu { position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .pause-menu.active { display: flex; }
        .pause-title { font-size: 40px; font-weight: 900; margin-bottom: 30px; letter-spacing: 2px; }

        .back-btn { position: absolute; top: 20px; left: 20px; background: none; border: none; color: #666; font-weight: bold; cursor: pointer; }
        .back-btn:hover { color: white; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.150.1/three.min.js"></script>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <div class="hero-title">INTRAMURAL<br><span style="color:var(--blue)">SCOUTING</span></div>
        <button class="menu-btn primary" onclick="nav('game')">PLAY 5v5</button>
        <button class="menu-btn" onclick="nav('gm')">LEAGUE EDITOR</button>
    </div>

    <div id="screen-gm" class="screen">
        <button class="back-btn" onclick="nav('menu')">‚Üê MENU</button>
        <div class="gm-sidebar" style="padding-top:60px">
            <div style="font-size:10px; color:#666; margin-bottom:10px; font-weight:bold;">TEAMS</div>
            <div id="team-list"></div>
            <button onclick="addTeam()" style="margin-top:10px; width:100%; background:#222; border:1px dashed #444; color:#888; padding:8px; cursor:pointer;">+ Add Team</button>
        </div>
        <div class="gm-content">
            <div id="roster-view" style="flex:1; display:none;">
                <h1 id="team-header" style="margin:0 0 20px 0;">Team</h1>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input type="text" id="ed-t-name" oninput="saveTeam()">
                    <input type="color" id="ed-t-col" oninput="saveTeam()" style="width:40px;">
                </div>
                <div id="player-list"></div>
                <button onclick="addPlayer()" style="margin-top:15px; background:var(--blue); color:white; border:none; padding:10px 20px; font-weight:bold; cursor:pointer;">+ Sign Player</button>
            </div>
            
            <div id="player-edit" class="editor-panel">
                <h2 style="margin-top:0; color:var(--blue);">Edit Attributes</h2>
                <div class="form-grid">
                    <div><label>Name</label><input type="text" id="p-name" oninput="savePlayer()"></div>
                    <div><label>#</label><input type="number" id="p-num" oninput="savePlayer()"></div>
                </div>
                <div class="form-grid">
                    <div><label>Height (in)</label><input type="number" id="p-h" oninput="savePlayer()"></div>
                    <div><label>Weight (lbs)</label><input type="number" id="p-w" oninput="savePlayer()"></div>
                </div>
                <div class="form-grid">
                    <div><label>Skin</label><input type="color" id="p-skin" oninput="savePlayer()"></div>
                    <div><label>Shoes</label><input type="color" id="p-shoe" oninput="savePlayer()"></div>
                </div>
                <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">
                    <label>Shooting: <span id="v-sht"></span></label><input type="range" id="p-sht" min="20" max="99" oninput="savePlayer()">
                    <label>Speed: <span id="v-spd"></span></label><input type="range" id="p-spd" min="20" max="99" oninput="savePlayer()">
                    <label>Defense: <span id="v-def"></span></label><input type="range" id="p-def" min="20" max="99" oninput="savePlayer()">
                </div>
                <button onclick="deletePlayer()" style="margin-top:20px; background:#450a0a; color:#fca5a5; border:none; padding:8px; width:100%; cursor:pointer;">Cut From Team</button>
            </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="hud-top">
            <div class="score-box"><div class="score-lbl">HOME</div><div class="score-num" style="color:var(--blue)" id="sc-h">0</div></div>
            <div class="score-box"><div class="score-lbl">AWAY</div><div class="score-num" style="color:var(--red)" id="sc-a">0</div></div>
        </div>
        
        <button class="pause-btn" onclick="togglePause()">II</button>

        <div class="feedback" id="feedback-txt">BUCKET!</div>
        <div class="controls-hint">
            <b style="color:white">ARROWS</b> Move<br>
            <b style="color:white">SHIFT</b> Sprint<br>
            <b style="color:white">SPACE</b> Shoot<br>
            <b style="color:var(--blue)">1, 2, 3, 4</b> Icon Pass
        </div>

        <div id="pause-menu" class="pause-menu">
            <div class="pause-title">GAME PAUSED</div>
            <button class="menu-btn primary" onclick="togglePause()">RESUME GAME</button>
            <button class="menu-btn" onclick="quitGame()">QUIT TO TITLE</button>
        </div>
    </div>

    <script>
        // --- 1. DATA CORE ---
        const DefP = { name:"New Player", num:0, h:69, w:160, skin:"#8d5524", shoes:"#fff", sht:60, spd:70, def:50 };
        
        const genRoster = (prefix) => Array.from({length:5}).map((_,i) => ({...DefP, id:prefix+i, name: prefix+' Player '+(i+1), num:i, h:69+i, spd:70-i}));

        let DB = JSON.parse(localStorage.getItem('bball_v6.3')) || {
            teams: [
                {id:'t1', name:'Bruzz Squad', color:'#3b82f6', roster: genRoster('t1')},
                {id:'t2', name:'The Opps', color:'#ef4444', roster: genRoster('t2')}
            ]
        };
        
        let app = { screen:'menu', tId:null, pId:null, gameOn:false };
        const save = () => localStorage.setItem('bball_v6.3', JSON.stringify(DB));
        const nav = (s) => {
            document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active'));
            document.getElementById('screen-'+s).classList.add('active');
            app.screen=s; 
            if(s==='gm') renderGM();
            if(s==='game') startGame();
            else stopGame();
        };

        // --- 2. GM UI ---
        function renderGM() {
            const list = document.getElementById('team-list'); list.innerHTML='';
            DB.teams.forEach(t => {
                const div = document.createElement('div');
                div.className = `team-card ${app.tId===t.id?'active':''}`;
                div.innerHTML = `<div class="color-dot" style="background:${t.color}"></div> ${t.name}`;
                div.onclick = () => { app.tId=t.id; renderGM(); renderRoster(); };
                list.appendChild(div);
            });
        }
        function renderRoster() {
            const t = DB.teams.find(x=>x.id===app.tId); if(!t) return;
            document.getElementById('roster-view').style.display='block';
            document.getElementById('ed-t-name').value=t.name;
            document.getElementById('ed-t-col').value=t.color;
            const list = document.getElementById('player-list'); list.innerHTML='';
            t.roster.forEach(p => {
                const row = document.createElement('div');
                row.style.padding='8px'; row.style.borderBottom='1px solid #333'; row.style.cursor='pointer';
                if(app.pId===p.id) row.style.color='var(--blue)';
                row.innerText = `#${p.num} ${p.name} (${Math.floor(p.h/12)}'${p.h%12}")`;
                row.onclick = () => { app.pId=p.id; renderRoster(); renderEditor(); };
                list.appendChild(row);
            });
        }
        function renderEditor() {
            const t = DB.teams.find(x=>x.id===app.tId);
            const p = t.roster.find(x=>x.id===app.pId);
            document.getElementById('player-edit').classList.add('active');
            const map = { 'p-name':p.name, 'p-num':p.num, 'p-h':p.h, 'p-w':p.w, 'p-skin':p.skin, 'p-shoe':p.shoes, 'p-sht':p.sht, 'p-spd':p.spd, 'p-def':p.def };
            for(let k in map) document.getElementById(k).value = map[k];
            ['sht','spd','def'].forEach(k => document.getElementById('v-'+k).innerText = p[k]);
        }
        
        window.saveTeam = () => { const t = DB.teams.find(x=>x.id===app.tId); t.name=document.getElementById('ed-t-name').value; t.color=document.getElementById('ed-t-col').value; save(); renderGM(); }
        window.savePlayer = () => {
            const t = DB.teams.find(x=>x.id===app.tId); const p = t.roster.find(x=>x.id===app.pId);
            p.name=document.getElementById('p-name').value; p.num=document.getElementById('p-num').value;
            p.h=parseInt(document.getElementById('p-h').value); p.w=parseInt(document.getElementById('p-w').value);
            p.skin=document.getElementById('p-skin').value; p.shoes=document.getElementById('p-shoe').value;
            p.sht=parseInt(document.getElementById('p-sht').value); p.spd=parseInt(document.getElementById('p-spd').value); p.def=parseInt(document.getElementById('p-def').value);
            save(); renderRoster(); renderEditor();
        }
        window.addTeam = () => { DB.teams.push({id:'t'+Date.now(), name:'New Team', color:'#fff', roster:genRoster('t'+Date.now())}); save(); renderGM(); };
        window.addPlayer = () => { const t=DB.teams.find(x=>x.id===app.tId); t.roster.push({...DefP, id:'p'+Date.now()}); save(); renderRoster(); };
        window.deletePlayer = () => { const t=DB.teams.find(x=>x.id===app.tId); t.roster=t.roster.filter(p=>p.id!==app.pId); app.pId=null; document.getElementById('player-edit').classList.remove('active'); save(); renderRoster(); };

        // --- 3. GAMEPLAY ENGINE (THREE.JS) ---
        let scene, camera, renderer, clock;
        let actors = [], ball;
        let scores = { h:0, a:0 };
        const keys = {};
        let engine = { paused: false };

        function stopGame() { app.gameOn = false; const c = document.querySelector('canvas'); if(c) c.remove(); }
        function quitGame() { stopGame(); nav('menu'); }
        function togglePause() { 
            engine.paused = !engine.paused; 
            const menu = document.getElementById('pause-menu');
            if(engine.paused) menu.classList.add('active');
            else menu.classList.remove('active');
        }

        function startGame() {
            if(DB.teams.length < 2) return alert("Need 2 teams!");
            app.gameOn = true; scores={h:0, a:0}; engine.paused=false;
            document.getElementById('pause-menu').classList.remove('active');
            updateScoreboard();

            // Setup
            scene = new THREE.Scene(); scene.background = new THREE.Color(0x111111); scene.fog = new THREE.Fog(0x111111, 40, 150);
            camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0,50,70); camera.lookAt(0,0,0);
            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('screen-game').appendChild(renderer.domElement);
            clock = new THREE.Clock();

            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(20, 80, 40); light.castShadow = true;
            light.shadow.mapSize.set(2048,2048); scene.add(light);

            // Court
            const floorMat = new THREE.MeshStandardMaterial({color:0x222});
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(200,200), floorMat);
            floor.rotation.x = -Math.PI/2; floor.position.y=-0.1; scene.add(floor);
            
            const cvs = document.createElement('canvas'); cvs.width=1024; cvs.height=2048; const ctx=cvs.getContext('2d');
            ctx.fillStyle='#d2a679'; ctx.fillRect(0,0,1024,2048);
            ctx.fillStyle='rgba(0,0,0,0.05)'; for(let i=0;i<2048;i+=16) ctx.fillRect(0,i,1024,2);
            ctx.fillStyle='#1e3a8a'; ctx.fillRect(362,0,300,380); ctx.fillRect(362,1668,300,380);
            ctx.strokeStyle='white'; ctx.lineWidth=20; ctx.strokeRect(50,50,924,1948);
            const tex = new THREE.CanvasTexture(cvs); tex.anisotropy=16;
            const court = new THREE.Mesh(new THREE.PlaneGeometry(50,94), new THREE.MeshStandardMaterial({map:tex}));
            court.rotation.x = -Math.PI/2; court.receiveShadow = true; scene.add(court);

            // Hoops
            const mkHoop = (z, rot) => {
                const g = new THREE.Group();
                const p = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,14), new THREE.MeshStandardMaterial({color:0x333})); p.position.y=7; g.add(p);
                const b = new THREE.Mesh(new THREE.BoxGeometry(6,4,0.2), new THREE.MeshStandardMaterial({color:0xffffff, transparent:true, opacity:0.8})); b.position.set(0,13,1.5); g.add(b);
                const r = new THREE.Mesh(new THREE.TorusGeometry(1.5,0.1,16,16), new THREE.MeshStandardMaterial({color:'orange'})); r.position.set(0,11,3); r.rotation.x=Math.PI/2; g.add(r);
                g.position.z = z; g.rotation.y = rot; scene.add(g);
            };
            mkHoop(-47, 0); mkHoop(47, Math.PI);

            // Ball
            ball = { mesh: new THREE.Mesh(new THREE.SphereGeometry(0.7), new THREE.MeshStandardMaterial({color:'orange'})), pos: new THREE.Vector3(0,5,0), vel: new THREE.Vector3(), owner: null, state: 'free' };
            ball.mesh.castShadow = true; scene.add(ball.mesh);

            // Icon Generator (Canvas Text)
            const mkIcon = (num) => {
                const c = document.createElement('canvas'); c.width=64; c.height=64;
                const x = c.getContext('2d');
                x.fillStyle = 'rgba(0,0,0,0.7)'; x.beginPath(); x.arc(32,32,30,0,Math.PI*2); x.fill();
                x.strokeStyle='white'; x.lineWidth=4; x.stroke();
                x.fillStyle='white'; x.font='bold 40px Arial'; x.textAlign='center'; x.textBaseline='middle';
                x.fillText(num, 32, 34);
                const t = new THREE.CanvasTexture(c);
                const s = new THREE.Sprite(new THREE.SpriteMaterial({map:t}));
                s.scale.set(3,3,3); s.position.y = 8;
                return s;
            };

            // 5v5 Player Spawn Logic
            actors = [];
            const spawnTeam = (team, side) => {
                // Ensure we have 5 players
                const roster = team.roster.slice(0,5);
                while(roster.length < 5) roster.push({...DefP}); 

                roster.forEach((p, idx) => {
                    const g = new THREE.Group();
                    const s = p.h / 75; const w = 1 + ((p.w-160)/300); g.scale.set(s,s,s);
                    const matJ = new THREE.MeshStandardMaterial({color: team.color});
                    const matS = new THREE.MeshStandardMaterial({color: p.skin});

                    const torso = new THREE.Mesh(new THREE.CapsuleGeometry(0.9*w, 2.5, 4, 8), matJ); torso.position.y=4; torso.castShadow=true; g.add(torso);
                    const head = new THREE.Mesh(new THREE.SphereGeometry(0.7, 16,16), matS); head.position.y=6.2; g.add(head);
                    
                    const legL = new THREE.Mesh(new THREE.CapsuleGeometry(0.35*w, 2.5, 4,8), matS); legL.position.set(-0.5*w, 1.25, 0); g.add(legL);
                    const legR = new THREE.Mesh(new THREE.CapsuleGeometry(0.35*w, 2.5, 4,8), matS); legR.position.set(0.5*w, 1.25, 0); g.add(legR);
                    const armL = new THREE.Mesh(new THREE.CapsuleGeometry(0.3*w, 2.5, 4,8), matS); armL.position.set(-1.2*w, 4, 0); armL.rotation.z=0.2; g.add(armL);
                    const armR = new THREE.Mesh(new THREE.CapsuleGeometry(0.3*w, 2.5, 4,8), matS); armR.position.set(1.2*w, 4, 0); armR.rotation.z=-0.2; g.add(armR);

                    // Add Pass Icon (Only for Home team, skipping player 0 who is user)
                    let passId = null;
                    if(side === 'home' && idx > 0) {
                        passId = idx; // 1, 2, 3, 4
                        const icon = mkIcon(passId);
                        g.add(icon);
                    }

                    // Position
                    let z = side==='home' ? 15 : -15;
                    let x = (idx - 2) * 8; 
                    g.position.set(x, 0, z);
                    
                    scene.add(g);
                    actors.push({ mesh: g, p: p, team: side, limbs: {legL, legR, armL, armR}, passKey: passId, cooldown:0 });
                });
            };

            spawnTeam(DB.teams[0], 'home');
            spawnTeam(DB.teams[1], 'away');

            // Ball starts with P1
            ball.owner = actors[0]; ball.state = 'dribble';

            animate();
        }

        function updateScoreboard() { document.getElementById('sc-h').innerText = scores.h; document.getElementById('sc-a').innerText = scores.a; }
        function showFeedback(txt) { const el = document.getElementById('feedback-txt'); el.innerText = txt; el.style.opacity = 1; setTimeout(() => el.style.opacity = 0, 1500); }

        // INPUT HANDLER (ARROWS + ICONS)
        window.onkeydown = e => { 
            if(e.key==='Escape') togglePause();
            if(engine.paused) return; // Block game input if paused

            // Movement keys map
            if(e.key === 'ArrowUp') keys.up = true;
            if(e.key === 'ArrowDown') keys.down = true;
            if(e.key === 'ArrowLeft') keys.left = true;
            if(e.key === 'ArrowRight') keys.right = true;
            if(e.key === 'Shift') keys.shift = true;
            if(e.code === 'Space') keys.space = true; 

            // Icon Passing
            if(['1','2','3','4'].includes(e.key)) passBall(parseInt(e.key));
        };
        
        window.onkeyup = e => { 
            if(e.key === 'ArrowUp') keys.up = false;
            if(e.key === 'ArrowDown') keys.down = false;
            if(e.key === 'ArrowLeft') keys.left = false;
            if(e.key === 'ArrowRight') keys.right = false;
            if(e.key === 'Shift') keys.shift = false;
            if(e.code === 'Space') { shootBall(); keys.space = false; }
        };

        function shootBall() {
            const user = actors[0];
            if(ball.owner !== user) return;
            ball.owner = null; ball.state = 'air';
            
            const hoopZ = user.mesh.position.z > 0 ? 41 : -41;
            const dx = 0 - user.mesh.position.x;
            const dz = hoopZ - user.mesh.position.z;
            const err = (100 - user.p.sht) * 0.005; 
            ball.vel.set(dx/40 + (Math.random()-0.5)*err, 1.2, dz/40 + (Math.random()-0.5)*err);
        }

        function passBall(targetIndex) {
            const user = actors[0];
            if(ball.owner !== user) return;
            
            // Find teammate with that passKey
            const target = actors.find(a => a.team === 'home' && a.passKey === targetIndex);
            
            if(target) {
                ball.owner = null; ball.state = 'air';
                const dx = target.mesh.position.x - user.mesh.position.x;
                const dz = target.mesh.position.z - user.mesh.position.z;
                ball.vel.set(dx/20, 0.5, dz/20);
                target.cooldown = 20;
            }
        }

        function animate() {
            if(!app.gameOn) return;
            requestAnimationFrame(animate);
            if(engine.paused) return; // Stop updates
            const dt = clock.getDelta();
            
            // 1. User Control (ARROWS)
            const user = actors[0];
            if(user) {
                const spd = (keys.shift ? 15 : 8) * dt * (user.p.spd / 70);
                if(keys.up) user.mesh.position.z -= spd; 
                if(keys.down) user.mesh.position.z += spd;
                if(keys.left) user.mesh.position.x -= spd; 
                if(keys.right) user.mesh.position.x += spd;
                
                // Cam
                camera.position.x += (user.mesh.position.x*0.5 - camera.position.x)*0.1;
                camera.position.z += ((user.mesh.position.z + 40) - camera.position.z)*0.1;
                camera.lookAt(user.mesh.position.x, 0, user.mesh.position.z);
            }

            // 2. Physics (Collisions)
            for(let i=0; i<actors.length; i++) {
                for(let j=i+1; j<actors.length; j++) {
                    const p1 = actors[i].mesh.position;
                    const p2 = actors[j].mesh.position;
                    const dist = p1.distanceTo(p2);
                    if(dist < 2.5) { 
                        const push = p1.clone().sub(p2).normalize().multiplyScalar(0.1);
                        p1.add(push); p2.sub(push);
                    }
                }
            }

            // 3. Ball
            if(ball.owner) {
                ball.mesh.position.copy(ball.owner.mesh.position);
                ball.mesh.position.y = 2.5 + Math.abs(Math.sin(Date.now()*0.015))*3;
                ball.mesh.position.z += 1.5;
            } else {
                ball.mesh.position.add(ball.vel);
                ball.vel.y -= 0.03;
                if(ball.mesh.position.y < 0.7) { ball.mesh.position.y = 0.7; ball.vel.y *= -0.7; }
                
                // Score?
                if(Math.abs(ball.mesh.position.z) > 40 && Math.abs(ball.mesh.position.z) < 42 && Math.abs(ball.mesh.position.x) < 2 && ball.mesh.position.y > 10 && ball.mesh.position.y < 12 && ball.vel.y < 0) {
                    showFeedback("SCORE!"); scores.h += 2; updateScoreboard(); ball.vel.set(0,0,0); ball.owner = user;
                }
                // Catch?
                actors.forEach(a => {
                    if(a.cooldown > 0) a.cooldown--;
                    else if(a.mesh.position.distanceTo(ball.mesh.position) < 2.5) { ball.owner = a; ball.state = 'dribble'; }
                });
            }

            // 4. AI & Anim
            actors.forEach(a => {
                // If I have ball and am AI, move to hoop
                if(ball.owner === a && a !== user) {
                    const hoopZ = a.team === 'home' ? -41 : 41; 
                    const tx = (ball.mesh.position.x + 0) * 0.5;
                    const tz = (ball.mesh.position.z + hoopZ) * 0.5;
                    a.mesh.position.x += (tx - a.mesh.position.x) * 0.02;
                    a.mesh.position.z += (tz - a.mesh.position.z) * 0.02;
                }
                
                // Anim legs
                a.limbs.legL.rotation.x = Math.sin(Date.now()*0.01 + a.mesh.position.x);
                a.limbs.legR.rotation.x = -Math.sin(Date.now()*0.01 + a.mesh.position.x);
            });

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
