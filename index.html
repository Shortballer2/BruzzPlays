<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Bruzz 3D: v0.7 Fixed</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Courier New', monospace; user-select: none; }
        
        /* Loading & Error Screen */
        #loader {
            position: absolute; inset: 0; background: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; font-size: 20px; font-weight: bold;
        }

        /* UI Panel */
        #ui-panel {
            position: absolute; top: 20px; left: 20px; width: 250px;
            background: rgba(20, 20, 20, 0.9); border: 1px solid #444;
            color: #eee; padding: 15px; border-radius: 8px; z-index: 100;
        }
        h2 { margin: 0 0 10px 0; font-size: 16px; border-bottom: 1px solid #555; padding-bottom: 5px; color: #3b82f6; }
        .control { margin-bottom: 12px; }
        .control label { display: flex; justify-content: space-between; font-size: 11px; color: #aaa; margin-bottom: 4px; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #3b82f6; }
    </style>
    
    <script>
        window.onerror = function(msg, url, line) {
            const loader = document.getElementById('loader');
            if(loader) {
                loader.innerHTML += `<div style="color:#ff5555; margin-top:20px; font-size:14px; text-align:center;">
                    ERROR: ${msg}<br>Line: ${line}
                </div>`;
            }
        };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.150.1/three.min.js"></script>
</head>
<body>

    <div id="loader">
        <div>INITIALIZING v0.7...</div>
    </div>

    <div id="ui-panel" style="display:none;">
        <h2>GOD MODE v0.7</h2>
        <div class="control">
            <label><span>SPEED</span> <span id="val-speed">1.0x</span></label>
            <input type="range" id="in-speed" min="0.1" max="2.0" step="0.1" value="1.0">
        </div>
        <div class="control">
            <label><span>HEIGHT</span> <span id="val-height">1.00m</span></label>
            <input type="range" id="in-height" min="0.5" max="2.0" step="0.1" value="1.0">
        </div>
        <div class="control">
            <label><span>DEFENSE IQ</span> <span id="val-iq">50</span></label>
            <input type="range" id="in-iq" min="0" max="100" value="50">
        </div>
        <div class="control">
            <label><span>AGGRESSION</span> <span id="val-agg">50</span></label>
            <input type="range" id="in-agg" min="0" max="100" value="50">
        </div>
        <div style="font-size: 10px; color: #666; margin-top: 10px;">WASD to Move</div>
    </div>

    <script>
        // Check if Three loaded correctly
        if (typeof THREE === 'undefined') {
            throw new Error("Engine failed to load. Check internet connection.");
        }

        // --- 1. CONFIG ---
        const settings = { speed: 1.0, height: 1.0, iq: 50, aggression: 50 };
        const keys = {};

        // Bind UI
        const uiPanel = document.getElementById('ui-panel');
        document.getElementById('in-speed').oninput = (e) => { settings.speed = parseFloat(e.target.value); updateUI(); };
        document.getElementById('in-height').oninput = (e) => { settings.height = parseFloat(e.target.value); updateUI(); };
        document.getElementById('in-iq').oninput = (e) => { settings.iq = parseInt(e.target.value); updateUI(); };
        document.getElementById('in-agg').oninput = (e) => { settings.aggression = parseInt(e.target.value); updateUI(); };

        function updateUI() {
            document.getElementById('val-speed').textContent = settings.speed.toFixed(1) + 'x';
            document.getElementById('val-height').textContent = settings.height.toFixed(2) + 'm';
            document.getElementById('val-iq').textContent = settings.iq;
            document.getElementById('val-agg').textContent = settings.aggression;
        }

        // --- 2. SCENE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111827);
        
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 30, 50);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Lights
        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(20, 50, 20);
        sun.castShadow = true;
        scene.add(sun);

        // Court
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x1e293b }));
        floor.rotation.x = -Math.PI / 2; floor.position.y = -0.1;
        scene.add(floor);

        const court = new THREE.Mesh(new THREE.PlaneGeometry(50, 94), new THREE.MeshStandardMaterial({ color: 0xd97736 }));
        court.rotation.x = -Math.PI / 2; court.receiveShadow = true;
        scene.add(court);

        // Hoop
        const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 14), new THREE.MeshStandardMaterial({ color: 0x333 }));
        pole.position.set(0, 7, 45); scene.add(pole);
        const rim = new THREE.Mesh(new THREE.TorusGeometry(1.5, 0.1, 8, 16), new THREE.MeshStandardMaterial({ color: 'orange' }));
        rim.rotation.x = Math.PI / 2; rim.position.set(0, 11, 43.5); scene.add(rim);

        // Players (CapsuleGeometry will work now!)
        const players = [
            { id: 0, x: 0, z: 20, team: 'us', color: 0x3b82f6, mesh: null },
            { id: 1, x: -15, z: 10, team: 'us', color: 0x60a5fa, mesh: null },
            { id: 5, x: 0, z: 15, team: 'them', color: 0xef4444, mesh: null },
        ];
        
        const pGeo = new THREE.CapsuleGeometry(1, 4, 4, 8);
        
        players.forEach(p => {
            const mesh = new THREE.Mesh(pGeo, new THREE.MeshStandardMaterial({ color: p.color }));
            mesh.castShadow = true; 
            mesh.position.set(p.x, 2, p.z);
            scene.add(mesh);
            p.mesh = mesh;
        });

        // Ball
        const ball = new THREE.Mesh(new THREE.SphereGeometry(0.8), new THREE.MeshStandardMaterial({ color: 0xff8800 }));
        ball.castShadow = true; scene.add(ball);

        // Controls
        window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- 3. LOOP ---
        let lastTime = 0;
        function animate(time) {
            requestAnimationFrame(animate);
            const dt = (time - lastTime) / 1000;
            lastTime = time;

            // Hide loader
            const loader = document.getElementById('loader');
            if(loader) { loader.remove(); uiPanel.style.display = 'block'; }

            // Movement
            const user = players[0];
            const speed = 15 * settings.speed * dt;
            if (keys['w']) user.z -= speed;
            if (keys['s']) user.z += speed;
            if (keys['a']) user.x -= speed;
            if (keys['d']) user.x += speed;

            // AI
            players.forEach(p => {
                if(p.id === 0) return;
                if(p.team === 'them') {
                    const target = players[0];
                    const guardDist = 12 - (settings.aggression / 10);
                    const dx = target.x - p.x;
                    const dz = (target.z + guardDist) - p.z;
                    const reaction = (settings.iq / 100) * 5 * dt;
                    p.x += dx * reaction; p.z += dz * reaction;
                }
            });

            // Update Visuals
            players.forEach(p => {
                p.mesh.position.set(p.x, 2 * settings.height, p.z);
                p.mesh.scale.set(1, settings.height, 1);
            });

            // Ball
            ball.position.set(user.x + 0.8, (2 * settings.height) + Math.abs(Math.sin(time * 0.008)) * 3, user.z + 1.2);
            
            // Camera
            camera.position.x += (user.x * 0.3 - camera.position.x) * 0.1;
            camera.lookAt(0, 5, 0);

            renderer.render(scene, camera);
        }

        animate(0);
    </script>
</body>
</html>
