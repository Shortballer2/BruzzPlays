<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Basketball Scouting Game v9.0 (AI Update)</title>
    <style>
        :root { --accent: #2563eb; --dark: #0f172a; --panel: #1e293b; --text: #f8fafc; }
        body { margin: 0; background: #000; color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; user-select: none; }
        
        /* SCREENS */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; }
        .screen.active { display: flex; animation: fade 0.3s ease-out; }
        @keyframes fade { from {opacity:0} to {opacity:1} }

        /* 1. MENU */
        #screen-menu { background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1504450758481-7338eba7524a?auto=format&fit=crop&w=1920&q=80'); background-size: cover; align-items: center; justify-content: center; }
        .hero-title { font-size: 80px; font-weight: 900; margin-bottom: 20px; text-transform: uppercase; letter-spacing: -3px; text-shadow: 0 4px 30px black; text-align: center; line-height: 0.9; }
        .menu-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 15px 50px; font-size: 18px; font-weight: 900; margin: 10px; cursor: pointer; transition: 0.2s; width: 350px; text-transform: uppercase; backdrop-filter: blur(10px); }
        .menu-btn:hover { background: white; color: black; transform: scale(1.05); }

        /* 2. GM DASHBOARD */
        #screen-gm { background: #111; flex-direction: row; }
        .gm-sidebar { width: 300px; background: #0f1115; border-right: 1px solid #222; padding: 30px; display: flex; flex-direction: column; }
        .gm-content { flex: 1; padding: 40px; overflow-y: auto; }
        .team-card { padding: 15px; background: #18181b; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 15px; border-radius: 6px; border: 1px solid #333; transition: 0.2s; }
        .team-card:hover, .team-card.active { border-color: var(--accent); background: #1e293b; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; }
        
        .editor-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 600px; background: #18181b; padding: 30px; border-radius: 12px; border: 1px solid #333; }
        .form-group label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
        .form-group input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 10px; border-radius: 4px; box-sizing: border-box; }
        .form-group input[type=color] { height: 40px; padding: 2px; }
        
        /* 3. GAME HUD */
        #screen-game { background: #000; }
        .tv-overlay { position: absolute; bottom: 40px; left: 60px; display: flex; align-items: flex-end; font-family: 'Arial Narrow', sans-serif; font-weight: bold; pointer-events: none; }
        .tv-score-box { background: #fff; color: #000; padding: 10px 20px; font-size: 24px; min-width: 60px; text-align: center; border-right: 1px solid #ccc; }
        .tv-score-val { background: #000; color: #fff; padding: 10px 20px; font-size: 28px; min-width: 50px; text-align: center; font-family: monospace; }
        
        .notify { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 15px 40px; border-radius: 4px; font-weight: 900; font-size: 32px; opacity: 0; transition: 0.3s; pointer-events: none; border: 2px solid white; text-transform: uppercase; letter-spacing: 2px; }
        
        .pause-menu { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .pause-menu.active { display: flex; }
        
        .back-btn { position: absolute; top: 30px; left: 30px; background: none; border: none; color: #666; font-weight: 900; cursor: pointer; font-size: 14px; letter-spacing: 1px; }
        .back-btn:hover { color: white; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.150.1/three.min.js"></script>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <div class="hero-title">BASKETBALL<br><span style="color:var(--accent)">SCOUTING</span></div>
        <button class="menu-btn" onclick="startGame()">PLAY GAME</button>
        <button class="menu-btn" onclick="nav('gm')">MANAGE ROSTERS</button>
    </div>

    <div id="screen-gm" class="screen">
        <button class="back-btn" onclick="nav('menu')">‚Üê MAIN MENU</button>
        <div class="gm-sidebar">
            <h3 style="color:#666; margin-top:0;">LEAGUE</h3>
            <div id="team-list"></div>
        </div>
        <div class="gm-content">
            <h1 id="gm-team-title" style="margin-top:0;">Select a Team</h1>
            
            <div id="gm-editor" style="display:none;">
                <div class="editor-form">
                    <div class="form-group"><label>Team Name</label><input type="text" id="ed-name" oninput="saveTeam()"></div>
                    <div class="form-group"><label>Color</label><input type="color" id="ed-col" oninput="saveTeam()"></div>
                </div>
                
                <h3 style="margin-top:40px; border-bottom:1px solid #333; padding-bottom:10px;">Starting Lineup</h3>
                <div id="player-list"></div>
                <p style="font-size:12px; color:#666; margin-top:10px;">* Note: Stats are auto-generated for simulation balance.</p>
            </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="tv-overlay">
            <div class="tv-score-box" id="name-h">HOME</div>
            <div class="tv-score-val" id="score-h">0</div>
            <div class="tv-score-box" id="name-a">AWAY</div>
            <div class="tv-score-val" id="score-a">0</div>
        </div>
        
        <div class="notify" id="notification">TIP OFF</div>
        
        <div style="position:absolute; top:20px; right:20px; text-align:right; font-size:12px; opacity:0.7;">
            <div style="font-weight:bold; color:var(--accent);">CONTROLS</div>
            ARROWS: Move<br>SPACE: Shoot / Switch Def<br>X: Switch Player<br>ESC: Pause
        </div>

        <div id="pause-menu" class="pause-menu">
            <h1 style="font-size:60px; margin-bottom:40px; font-weight:900;">PAUSED</h1>
            <button class="menu-btn" onclick="togglePause()">RESUME</button>
            <button class="menu-btn" onclick="quitGame()">QUIT TO MENU</button>
        </div>
    </div>

    <script>
        // --- 1. DATA CORE ---
        const DefP = { name:"Player", h:75, w:200, skin:"#8d5524", num:0 };
        const GenRoster = (pf) => Array.from({length:5}).map((_,i)=>({...DefP, id:pf+i, name:pf+' '+(i+1), num:i}));

        let DB = JSON.parse(localStorage.getItem('bsg_v9')) || {
            teams: [
                {id:'t1', name:'BRUZZ', color:'#2563eb', roster:GenRoster('B')},
                {id:'t2', name:'OPPS', color:'#dc2626', roster:GenRoster('O')}
            ]
        };
        const save = () => localStorage.setItem('bsg_v9', JSON.stringify(DB));

        let app = { screen:'menu', activeT:null, game:null };

        function nav(s) {
            document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active'));
            document.getElementById('screen-'+s).classList.add('active');
            app.screen=s; 
            if(s==='gm') renderGM();
        }

        // --- 2. GM EDITOR ---
        function renderGM() {
            const list = document.getElementById('team-list'); list.innerHTML='';
            DB.teams.forEach(t => {
                const d = document.createElement('div');
                d.className = `team-card ${app.activeT===t.id?'active':''}`;
                d.innerHTML = `<div class="color-dot" style="background:${t.color}"></div> ${t.name}`;
                d.onclick = () => { app.activeT=t.id; renderGM(); loadTeam(); };
                list.appendChild(d);
            });
        }
        function loadTeam() {
            const t = DB.teams.find(x=>x.id===app.activeT);
            document.getElementById('gm-editor').style.display='block';
            document.getElementById('gm-team-title').innerText = t.name;
            document.getElementById('ed-name').value = t.name;
            document.getElementById('ed-col').value = t.color;
            
            const pl = document.getElementById('player-list'); pl.innerHTML='';
            t.roster.forEach(p => {
                const row = document.createElement('div');
                row.style.cssText = "display:flex; justify-content:space-between; padding:10px; background:#222; margin-bottom:5px; font-family:monospace;";
                row.innerHTML = `<span>#${p.num} ${p.name}</span> <span style="color:#888">${Math.floor(p.h/12)}'${p.h%12}"</span>`;
                pl.appendChild(row);
            });
        }
        window.saveTeam = () => {
            const t = DB.teams.find(x=>x.id===app.activeT);
            t.name = document.getElementById('ed-name').value;
            t.color = document.getElementById('ed-col').value;
            save(); renderGM();
        };

        // --- 3. GAME ENGINE ---
        let scene, camera, renderer, clock;
        let actors=[], ball;
        let keys={};

        function startGame() {
            nav('game');
            app.game = { active:true, paused:false, possession:'home', score:{h:0,a:0} };
            
            // Setup ThreeJS
            scene = new THREE.Scene(); scene.background=new THREE.Color(0x111); scene.fog=new THREE.Fog(0x111, 50, 150);
            camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('screen-game').appendChild(renderer.domElement);
            
            // Lights & Court
            const amb = new THREE.AmbientLight(0xffffff, 0.5); scene.add(amb);
            const spot = new THREE.SpotLight(0xffffff, 1.0); spot.position.set(20,80,40); spot.castShadow=true; scene.add(spot);
            
            // Glossy Floor
            const cvs = document.createElement('canvas'); cvs.width=1024; cvs.height=2048; const ctx=cvs.getContext('2d');
            ctx.fillStyle='#d2a679'; ctx.fillRect(0,0,1024,2048);
            ctx.fillStyle='rgba(0,0,0,0.05)'; for(let i=0;i<2048;i+=16) ctx.fillRect(0,i,1024,2);
            ctx.fillStyle='#1e3a8a'; ctx.fillRect(362,0,300,380); ctx.fillRect(362,1668,300,380);
            ctx.strokeStyle='white'; ctx.lineWidth=20; ctx.strokeRect(50,50,924,1948);
            const tex=new THREE.CanvasTexture(cvs); tex.anisotropy=16;
            const court=new THREE.Mesh(new THREE.PlaneGeometry(50,94), new THREE.MeshStandardMaterial({map:tex, roughness:0.2}));
            court.rotation.x=-Math.PI/2; court.receiveShadow=true; scene.add(court);

            // Hoops
            const mkHoop=(z,r)=>{
                const g=new THREE.Group();
                const p=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,14), new THREE.MeshStandardMaterial({color:0x333})); p.position.y=7; g.add(p);
                const b=new THREE.Mesh(new THREE.BoxGeometry(6,4,0.2), new THREE.MeshStandardMaterial({color:0xffffff})); b.position.set(0,13,1.5); g.add(b);
                const rm=new THREE.Mesh(new THREE.TorusGeometry(1.5,0.1,16,16), new THREE.MeshStandardMaterial({color:'orange'})); rm.position.set(0,11,3); rm.rotation.x=Math.PI/2; g.add(rm);
                g.position.z=z; g.rotation.y=r; scene.add(g);
            };
            mkHoop(-47,0); mkHoop(47,Math.PI);

            // Players (Voxel Style)
            actors = [];
            const spawnTeam = (team, side) => {
                team.roster.forEach((p,i)=>{
                    const g = new THREE.Group();
                    const matJ = new THREE.MeshStandardMaterial({color:team.color});
                    const matS = new THREE.MeshStandardMaterial({color:p.skin});
                    
                    const torso = new THREE.Mesh(new THREE.BoxGeometry(1.5,2.5,0.8), matJ); torso.position.y=4.25; torso.castShadow=true; g.add(torso);
                    const head = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.9,0.8), matS); head.position.y=6; g.add(head);
                    const legL = new THREE.Mesh(new THREE.BoxGeometry(0.5,2,0.5), matS); legL.position.set(-0.4,1,0); g.add(legL);
                    const legR = new THREE.Mesh(new THREE.BoxGeometry(0.5,2,0.5), matS); legR.position.set(0.4,1,0); g.add(legR);
                    
                    // Initial Positions (Standard 2-3 Setup)
                    const z = side==='home' ? 15 : -15;
                    const x = (i-2)*8; 
                    g.position.set(x,0,z);
                    scene.add(g);
                    
                    actors.push({
                        mesh: g, team: side, idx: i, 
                        role: i, // 0=PG, 1=SG, 2=SF, 3=PF, 4=C
                        userControlled: (side==='home' && i===0), // Start as PG
                        limbs: {legL, legR}
                    });
                });
            };
            spawnTeam(DB.teams[0], 'home');
            spawnTeam(DB.teams[1], 'away');
            
            // Update HUD Names
            document.getElementById('name-h').innerText = DB.teams[0].name.substring(0,3);
            document.getElementById('name-a').innerText = DB.teams[1].name.substring(0,3);

            // Ball
            ball = { mesh:new THREE.Mesh(new THREE.SphereGeometry(0.7), new THREE.MeshStandardMaterial({color:'orange'})), pos:new THREE.Vector3(), vel:new THREE.Vector3(), owner:actors[0], state:'dribble' };
            scene.add(ball.mesh);

            clock = new THREE.Clock();
            animate();
        }

        // --- 4. ADVANCED AI & CONTROLS ---
        window.onkeydown=e=>{ if(e.key==='Escape') togglePause(); if(app.game.paused)return; keys[e.key]=true; if(e.key==='x') switchPlayer(); if(e.code==='Space') handleSpace(); };
        window.onkeyup=e=>{ keys[e.key]=false; };

        function switchPlayer() {
            // Find teammate closest to ball (DEFENSE)
            if(ball.owner && ball.owner.team === 'home') return; // Can't switch on offense if you have ball
            
            let best = null, minD = 999;
            actors.filter(a=>a.team==='home').forEach(a => {
                a.userControlled = false;
                const d = a.mesh.position.distanceTo(ball.mesh.position);
                if(d < minD) { minD=d; best=a; }
            });
            if(best) best.userControlled = true;
        }

        function handleSpace() {
            // Offense: Shoot / Defense: Switch
            const u = actors.find(a=>a.userControlled);
            if(ball.owner === u) shoot(u);
            else switchPlayer();
        }

        function shoot(u) {
            ball.owner = null; ball.state = 'air';
            const hoopZ = u.mesh.position.z>0 ? 43 : -43;
            const dx = 0 - u.mesh.position.x;
            const dz = hoopZ - u.mesh.position.z;
            ball.vel.set(dx*0.045, 1.0, dz*0.045);
        }

        function animate() {
            if(!app.game.active) return;
            requestAnimationFrame(animate);
            if(app.game.paused) return;
            const dt = clock.getDelta();

            // 1. GAME LOGIC PER ACTOR
            actors.forEach(a => {
                let move = new THREE.Vector3();

                // === USER CONTROL ===
                if(a.userControlled) {
                    const spd = keys.Shift ? 15 : 9;
                    if(keys.ArrowUp) move.z-=1; if(keys.ArrowDown) move.z+=1;
                    if(keys.ArrowLeft) move.x-=1; if(keys.ArrowRight) move.x+=1;
                    if(move.lengthSq()>0) move.normalize().multiplyScalar(spd*dt);
                    
                    // Auto-Switch Defense Logic: If CPU passes, switch user to nearest defender
                    if(!ball.owner && ball.state==='air' && a.team!=='home') {
                        // (Simplified: just stick to current)
                    }
                } 
                // === AI LOGIC ===
                else {
                    const hoopZ = a.team==='home' ? 43 : -43; // Defending hoop
                    const attackZ = a.team==='home' ? -43 : 43; // Attacking hoop

                    if(ball.owner && ball.owner.team === a.team) {
                        // OFFENSE (Spacing)
                        if(ball.owner === a) {
                            // Dribbler AI: Drive to hoop
                            const dx = 0 - a.mesh.position.x; const dz = attackZ - a.mesh.position.z;
                            move.set(dx, 0, dz).normalize().multiplyScalar(8*dt);
                        } else {
                            // Off-Ball: Go to spots (Corners/Wings) based on role
                            let tx = 0, tz = attackZ + (a.team==='home'?20:-20);
                            if(a.role===1) { tx=20; tz=attackZ+(a.team==='home'?10:-10); } // Corner
                            if(a.role===2) { tx=-20; }
                            move.set(tx - a.mesh.position.x, 0, tz - a.mesh.position.z).multiplyScalar(2*dt);
                        }
                    } else {
                        // DEFENSE (Stay between man and hoop)
                        // Find my assignment (matching role on other team)
                        const man = actors.find(e => e.team !== a.team && e.role === a.role);
                        if(man) {
                            const gx = (man.mesh.position.x + 0)*0.5; // Midpoint to hoop x=0
                            const gz = (man.mesh.position.z + hoopZ)*0.5;
                            
                            // Help Defense: If ball is close, sag off man
                            if(ball.mesh.position.distanceTo(a.mesh.position) < 10) {
                                move.set(ball.mesh.position.x - a.mesh.position.x, 0, ball.mesh.position.z - a.mesh.position.z).multiplyScalar(0.5);
                            }
                            
                            move.add(new THREE.Vector3(gx - a.mesh.position.x, 0, gz - a.mesh.position.z)).multiplyScalar(4*dt);
                        }
                    }
                }

                // Apply Move
                a.mesh.position.add(move);
                
                // Animation
                if(move.lengthSq() > 0.001) {
                    a.limbs.legL.rotation.x = Math.sin(Date.now()*0.015);
                    a.limbs.legR.rotation.x = -Math.sin(Date.now()*0.015);
                }
            });

            // 2. BALL PHYSICS
            if(ball.owner) {
                ball.mesh.position.copy(ball.owner.mesh.position);
                ball.mesh.position.y = 3 + Math.abs(Math.sin(Date.now()*0.015))*2;
                ball.mesh.position.z += 1.0;
            } else {
                ball.mesh.position.add(ball.vel);
                ball.vel.y -= 0.03;
                if(ball.mesh.position.y<0.7) { ball.mesh.position.y=0.7; ball.vel.y*=-0.7; }
                
                // Score
                if(Math.abs(ball.mesh.position.z)>42 && Math.abs(ball.mesh.position.x)<2 && ball.mesh.position.y>10 && ball.vel.y<0) {
                    score(ball.mesh.position.z>0 ? 'away':'home');
                }
                // Catch
                actors.forEach(a=>{
                    if(a.mesh.position.distanceTo(ball.mesh.position)<2.5) { ball.owner=a; ball.state='dribble'; }
                });
            }

            // 3. CAMERA (TV Style)
            const focus = ball.owner ? ball.owner.mesh.position : ball.mesh.position;
            camera.position.x += (40 + focus.x*0.2 - camera.position.x)*0.05;
            camera.position.z += (focus.z*0.4 - camera.position.z)*0.05;
            camera.lookAt(focus.x, 0, focus.z);

            renderer.render(scene, camera);
        }

        function score(team) {
            app.game.score[team==='home'?'h':'a'] += 2;
            document.getElementById('score-h').innerText = app.game.score.h;
            document.getElementById('score-a').innerText = app.game.score.a;
            
            const el = document.getElementById('notification');
            el.innerText = "BUCKET!"; el.style.opacity=1;
            setTimeout(()=>el.style.opacity=0, 2000);
            
            ball.vel.set(0,0,0); ball.owner=null; ball.mesh.position.set(0,5,0); // Reset center
        }

        function togglePause() { 
            app.game.paused = !app.game.paused; 
            document.getElementById('pause-menu').classList.toggle('active');
        }
        function quitGame() { 
            app.game.active=false; document.querySelector('canvas').remove(); 
            nav('menu'); 
        }

    </script>
</body>
</html>
