<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Basketball Sim v18.0 (Fouls & Free Throws)</title>
    <style>
        :root { --blue: #2563eb; --red: #dc2626; --bg: #0f172a; --text: #f8fafc; }
        body { margin: 0; background: #000; color: var(--text); font-family: 'Segoe UI', monospace; overflow: hidden; user-select: none; }
        
        /* UI LAYOUT */
        .screen { position: absolute; inset: 0; display: none; }
        .screen.active { display: block; }

        /* HUD */
        .tv-overlay {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: flex-end; 
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.8));
        }
        .tv-bar { display: flex; background: #111; border: 2px solid #444; border-radius: 6px; overflow: hidden; }
        .tv-team { width: 80px; padding: 12px; text-align: center; font-size: 20px; color: white; font-weight: 900; }
        .tv-score { width: 60px; background: #eee; color: #111; font-size: 32px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: monospace; }
        .tv-foul { font-size: 10px; color: #facc15; margin-top: 4px; display: block; }
        .tv-clock { background: #222; color: #f00; width: 100px; font-size: 24px; display: flex; align-items: center; justify-content: center; font-family: monospace; border-left: 1px solid #444; }

        /* NOTIFICATIONS & WHISTLE */
        .notify {
            position: absolute; top: 150px; left: 50%; transform: translateX(-50%); 
            font-size: 50px; font-weight: 900; font-style: italic;
            text-shadow: 0 4px 10px rgba(0,0,0,0.8);
            opacity: 0; pointer-events: none; transition: transform 0.2s, opacity 0.2s;
            text-align: center; width: 100%;
        }
        .notify.whistle { color: #fbbf24; text-transform: uppercase; letter-spacing: 5px; }
        .notify.active { opacity: 1; transform: translateX(-50%) scale(1.1); }

        /* FREE THROW METER */
        .ft-meter-container {
            position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%);
            width: 300px; height: 30px; background: #222; border: 2px solid white; border-radius: 15px;
            display: none; overflow: hidden;
        }
        .ft-meter-bar { width: 100%; height: 100%; position: relative; }
        .ft-zone { position: absolute; left: 45%; width: 10%; height: 100%; background: #22c55e; }
        .ft-cursor { position: absolute; left: 0%; width: 4px; height: 100%; background: white; transition: none; }

        /* MENU */
        #menu { background: #080808; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .title { font-size: 70px; font-weight: 900; line-height: 0.9; text-align: center; margin-bottom: 30px; text-transform: uppercase; letter-spacing: -2px; }
        .btn { 
            background: rgba(255,255,255,0.05); border: 1px solid #444; color: white; padding: 18px 50px; 
            font-size: 16px; font-weight: 800; margin: 8px; cursor: pointer; width: 300px; 
            text-transform: uppercase; letter-spacing: 2px; transition: 0.2s;
        }
        .btn:hover { background: #fff; color: #000; transform: scale(1.02); }
        .btn.primary { border-color: var(--blue); background: rgba(37, 99, 235, 0.2); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.150.1/three.min.js"></script>
</head>
<body>

    <div id="menu" class="screen active">
        <div class="title">Official<br><span style="color:var(--blue)">Rules</span> Update</div>
        <div style="color:#666; margin-bottom:40px; font-size:12px; letter-spacing:2px;">FOULS • FREE THROWS • THE BONUS</div>
        <button class="btn primary" onclick="initGame()">Tip Off</button>
    </div>

    <div id="game" class="screen">
        <div class="tv-overlay">
            <div class="tv-bar">
                <div class="tv-team" style="background:var(--blue)">
                    HM<span class="tv-foul" id="foul-h">FLS: 0</span>
                </div>
                <div class="tv-score" id="sc-h">0</div>
                <div class="tv-score" id="sc-a">0</div>
                <div class="tv-team" style="background:var(--red)">
                    AW<span class="tv-foul" id="foul-a">FLS: 0</span>
                </div>
                <div class="tv-clock" id="clock">10:00</div>
            </div>
        </div>

        <div id="feedback" class="notify whistle">WHISTLE!</div>

        <div id="ft-ui" class="ft-meter-container">
            <div class="ft-meter-bar">
                <div class="ft-zone"></div>
                <div class="ft-cursor" id="ft-cursor"></div>
            </div>
            <div style="position:absolute; top:-25px; width:100%; text-align:center; font-size:12px; font-weight:bold;">PRESS SPACE IN GREEN</div>
        </div>
        
        <div id="controls" style="position:absolute; top:20px; right:20px; text-align:right; font-size:11px; color:#888;">
            <b>ARROWS</b> Move<br><b>SPACE</b> Shoot / Jump<br><b>X</b> Pass / Steal
        </div>
    </div>

    <script>
        // --- 1. CONFIG ---
        const CFG = {
            gravity: -0.025,
            friction: 0.88,
            accel: 0.04,
            maxSpeed: 0.35,
            stealRange: 2.2,
            foulChanceReach: 0.4, // 40% chance of foul on bad reach
            foulChanceBlock: 0.3, // Collision foul chance
            bonusLimit: 5
        };

        const Game = {
            active: false, paused: false,
            clock: 600,
            possession: 'home',
            scores: { home: 0, away: 0 },
            fouls: { home: 0, away: 0 },
            actors: [],
            ball: null,
            mode: 'play', // play, dead, freethrow
            ftState: { shooter: null, shots: 0, taken: 0, active: false, speed: 2, val: 0, dir: 1 }
        };

        // --- 2. THREE.JS SETUP ---
        let scene, camera, renderer, clock;
        const keys = {};

        function initGame() {
            document.getElementById('menu').classList.remove('active');
            document.getElementById('game').classList.add('active');

            scene = new THREE.Scene(); scene.background = new THREE.Color(0x0a0a0a);
            camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 55, 85); camera.lookAt(0,0,5);

            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('game').appendChild(renderer.domElement);

            // Lights & Court
            const amb = new THREE.AmbientLight(0xffffff, 0.5); scene.add(amb);
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(20, 80, 40); sun.castShadow = true;
            sun.shadow.mapSize.set(2048,2048); scene.add(sun);

            const cvs = document.createElement('canvas'); cvs.width=1024; cvs.height=2048; const ctx=cvs.getContext('2d');
            ctx.fillStyle='#dcb388'; ctx.fillRect(0,0,1024,2048);
            ctx.fillStyle='#1e3a8a'; ctx.fillRect(362,0,300,380); ctx.fillRect(362,1668,300,380);
            ctx.strokeStyle='white'; ctx.lineWidth=15; ctx.strokeRect(50,50,924,1948);
            const tex = new THREE.CanvasTexture(cvs); tex.anisotropy=16;
            const court = new THREE.Mesh(new THREE.PlaneGeometry(50,94), new THREE.MeshStandardMaterial({map:tex, roughness:0.3}));
            court.rotation.x = -Math.PI/2; court.receiveShadow=true; scene.add(court);

            // Hoops
            const mkHoop=(z)=>{
                const g=new THREE.Group();
                const p=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.2,14), new THREE.MeshStandardMaterial({color:0x222})); p.position.y=7; g.add(p);
                const b=new THREE.Mesh(new THREE.BoxGeometry(6,4,0.1), new THREE.MeshStandardMaterial({color:0xffffff})); b.position.set(0,13,1.5); g.add(b);
                const r=new THREE.Mesh(new THREE.TorusGeometry(1.5,0.1,16,16), new THREE.MeshStandardMaterial({color:'orange'})); r.position.set(0,11,3); r.rotation.x=Math.PI/2; g.add(r);
                g.position.z=z; if(z>0)g.rotation.y=Math.PI; scene.add(g);
            };
            mkHoop(-47); mkHoop(47);

            // Ball
            Game.ball = {
                mesh: new THREE.Mesh(new THREE.SphereGeometry(0.65), new THREE.MeshStandardMaterial({color:0xff6600})),
                pos: new THREE.Vector3(0,5,0), vel: new THREE.Vector3(), owner: null, state: 'loose'
            };
            Game.ball.mesh.castShadow = true; scene.add(Game.ball.mesh);

            // Players
            Game.actors = [];
            spawnTeam('home', 0x2563eb, 1);
            spawnTeam('away', 0xdc2626, -1);

            // Start
            Game.ball.owner = Game.actors[0]; Game.ball.state = 'dribble';
            Game.active = true;
            clock = new THREE.Clock();
            animate();
        }

        function spawnTeam(id, col, dir) {
            for(let i=0; i<5; i++) {
                const g = new THREE.Group(); g.position.set((i-2)*6, 0, dir*20); scene.add(g);
                const mat = new THREE.MeshStandardMaterial({color:col});
                const skin = new THREE.MeshStandardMaterial({color:0x8d5524});
                
                // Simple Rig
                const body = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.4,1.5), mat); body.position.y=2.5; g.add(body);
                const head = new THREE.Mesh(new THREE.SphereGeometry(0.4), skin); head.position.y=3.5; g.add(head);
                const ind = new THREE.Mesh(new THREE.ConeGeometry(0.2,0.5,4), new THREE.MeshBasicMaterial({color:0xffff00})); 
                ind.position.y=4.5; ind.rotation.x=Math.PI; if(id==='home'&&i===0) g.add(ind);

                Game.actors.push({
                    mesh: g, team: id, user: (id==='home'&&i===0), role: i,
                    vel: new THREE.Vector3(), cooldown: 0, isShooting: false
                });
            }
        }

        // --- 3. GAMEPLAY & FOUL LOGIC ---
        function animate() {
            if(!Game.active) return;
            requestAnimationFrame(animate);
            if(Game.mode === 'freethrow') { updateFreeThrow(); renderer.render(scene, camera); return; }
            if(Game.mode === 'dead') { renderer.render(scene, camera); return; }

            const dt = 1;

            Game.actors.forEach(a => {
                // Physics & AI (Simplified from v16 for clarity on Foul Logic)
                const acc = new THREE.Vector3();
                if(a.user) {
                    if(keys['ArrowUp']) acc.z-=CFG.accel; if(keys['ArrowDown']) acc.z+=CFG.accel;
                    if(keys['ArrowLeft']) acc.x-=CFG.accel; if(keys['ArrowRight']) acc.x+=CFG.accel;
                } else {
                    // AI Defense
                    if(Game.ball.owner && Game.ball.owner.team !== a.team) {
                        const hoopZ = a.team==='home'?-41:41;
                        const target = new THREE.Vector3(Game.ball.mesh.position.x*0.5, 0, (Game.ball.mesh.position.z+hoopZ)*0.5);
                        acc.subVectors(target, a.mesh.position).normalize().multiplyScalar(CFG.accel*0.8);
                        
                        // AI Reach Foul Chance
                        if(Game.ball.owner.user && a.mesh.position.distanceTo(Game.ball.mesh.position) < 1.5 && Math.random() < 0.002) {
                            callFoul(a, Game.ball.owner, "REACH-IN");
                        }
                    }
                }
                
                if(a.cooldown>0) a.cooldown--;
                if(a.cooldown<=0) { a.vel.add(acc); a.vel.multiplyScalar(CFG.friction); a.mesh.position.add(a.vel); }
                if(a.vel.lengthSq()>0.001) a.mesh.rotation.y = Math.atan2(a.vel.x, a.vel.z);

                // Collision -> Blocking Foul?
                Game.actors.forEach(b => {
                    if(a!==b && a.mesh.position.distanceTo(b.mesh.position) < 1.5) {
                        // Push
                        const push = a.mesh.position.clone().sub(b.mesh.position).normalize().multiplyScalar(0.05);
                        a.mesh.position.add(push);
                        
                        // Check Blocking Foul (If B has ball and A is moving fast into B)
                        if(Game.ball.owner === b && a.team !== b.team && a.vel.length() > 0.1) {
                            if(Math.random() < CFG.foulChanceBlock) callFoul(a, b, "BLOCKING FOUL");
                        }
                    }
                });
            });

            // Ball
            const b = Game.ball;
            if(b.owner) {
                const p = b.owner.mesh.position;
                b.pos.set(p.x + Math.sin(Date.now()*0.01), 3, p.z+1.0);
            } else {
                b.vel.y += CFG.gravity; b.pos.add(b.vel);
                if(b.pos.y<0.6) { b.pos.y=0.6; b.vel.y*=-0.7; }
                
                const hoopZ = b.vel.z>0?47:-47;
                if(Math.abs(b.pos.z-hoopZ)<1.5 && Math.abs(b.pos.x)<1.5 && Math.abs(b.pos.y-11)<1) {
                    if(b.vel.y<0) score(b.vel.z>0?'away':'home');
                }
                // Rebound
                Game.actors.forEach(a=>{
                    if(a.mesh.position.distanceTo(b.pos)<2 && a.cooldown<=0) { b.owner=a; b.state='dribble'; }
                });
            }
            b.mesh.position.copy(b.pos);

            // Cam
            const t = b.owner ? b.owner.mesh.position : b.pos;
            camera.position.x += (30 + t.x*0.1 - camera.position.x)*0.05;
            camera.position.z += (t.z*0.5 - camera.position.z)*0.05;
            camera.lookAt(t.x, 0, t.z);

            renderer.render(scene, camera);
        }

        // --- 4. FOUL SYSTEM ---
        function callFoul(defender, offender, type) {
            Game.mode = 'dead';
            Game.fouls[defender.team]++;
            updateHUD();
            showNotify(type + "!");

            // Check Bonus
            const isBonus = Game.fouls[defender.team] >= CFG.bonusLimit;
            const isShooting = offender.isShooting; // Assume flag set during shot

            setTimeout(() => {
                if(isShooting || isBonus) {
                    startFreeThrows(offender, isShooting ? 2 : 1); // 2 shots if shooting, 1-and-1 logic simplified to 1
                } else {
                    resetInbound(offender.team);
                }
            }, 2000);
        }

        function startFreeThrows(player, count) {
            Game.mode = 'freethrow';
            Game.ftState = { shooter: player, shots: count, taken: 0, active: true, val: 50, dir: 1, speed: 2 };
            
            // Move Camera & Players
            const hoopZ = player.team==='home' ? -47 : 47;
            const lineZ = player.team==='home' ? -32 : 32;
            const dir = player.team==='home' ? -1 : 1;

            player.mesh.position.set(0, 0, lineZ);
            player.mesh.lookAt(0, 0, hoopZ);
            Game.ball.owner = player;
            Game.ball.state = 'dribble';

            // Clear lane (Simple teleport away)
            Game.actors.forEach(a => {
                if(a !== player) a.mesh.position.set(100, 0, 0); // Hide others for simplicity or move to lane
            });

            // Cam behind shooter
            camera.position.set(0, 20, lineZ - (15*dir));
            camera.lookAt(0, 10, hoopZ);

            document.getElementById('ft-ui').style.display = 'block';
        }

        function updateFreeThrow() {
            const st = Game.ftState;
            if(!st.active) return;

            // Bounce Meter
            st.val += st.speed * st.dir;
            if(st.val > 100 || st.val < 0) st.dir *= -1;
            document.getElementById('ft-cursor').style.left = st.val + '%';

            // Dribble Anim
            const p = st.shooter.mesh.position;
            Game.ball.pos.set(p.x, 3 + Math.sin(Date.now()*0.02), p.z + (st.shooter.team==='home'?-1:1));
            Game.ball.mesh.position.copy(Game.ball.pos);
        }

        function releaseFreeThrow() {
            const st = Game.ftState;
            if(!st.active) return;
            st.active = false;

            // Check Accuracy (Green Zone 45-55)
            const accuracy = Math.abs(st.val - 50);
            const isGood = accuracy < 8; // 8% tolerance

            // Animate Shot
            Game.ball.owner = null;
            const hoopZ = st.shooter.team==='home' ? -47 : 47;
            const dist = Math.abs(hoopZ - st.shooter.mesh.position.z);
            
            // Trajectory
            const errX = (Math.random()-0.5) * (isGood ? 0.01 : 0.2);
            const velZ = (hoopZ - st.shooter.mesh.position.z) / 40;
            const velY = 0.8 + (dist * 0.005);
            Game.ball.vel.set(errX, velY, velZ);

            setTimeout(() => {
                if(isGood) {
                    Game.scores[st.shooter.team]++;
                    updateHUD();
                    showNotify("GOOD!");
                } else {
                    showNotify("MISS!");
                }
                
                st.taken++;
                if(st.taken < st.shots) {
                    setTimeout(() => startFreeThrows(st.shooter, st.shots), 2000); // Next shot
                } else {
                    setTimeout(() => resetInbound(st.shooter.team==='home'?'away':'home'), 2000);
                }
            }, 1000);
        }

        // --- 5. UTILS & INPUT ---
        window.addEventListener('keydown', e => {
            if(e.key==='ArrowUp') keys.ArrowUp=true; if(e.key==='ArrowDown') keys.ArrowDown=true;
            if(e.key==='ArrowLeft') keys.ArrowLeft=true; if(e.key==='ArrowRight') keys.ArrowRight=true;
            
            if(e.code==='Space') {
                if(Game.mode === 'freethrow') releaseFreeThrow();
                else if(Game.mode === 'play') { /* Jump/Shoot logic */ }
            }
            
            if(e.key==='x') {
                const u = Game.actors.find(a=>a.user);
                // Steal Logic
                if(u && !Game.ball.owner || Game.ball.owner.team !== u.team) {
                    if(Game.ball.owner && u.mesh.position.distanceTo(Game.ball.mesh.position) < CFG.stealRange) {
                        if(Math.random() < 0.3) {
                            showNotify("STEAL!");
                            Game.ball.owner = null; Game.ball.vel.y = 0.5; // Pop loose
                        } else {
                            // Failed steal -> Reach Foul?
                            if(Math.random() < CFG.foulChanceReach) callFoul(u, Game.ball.owner, "REACH-IN");
                            else { u.cooldown = 60; } // Stun
                        }
                    }
                }
            }
        });
        window.addEventListener('keyup', e => {
            if(e.key.startsWith('Arrow')) keys[e.key]=false;
        });

        function resetInbound(team) {
            Game.mode = 'play';
            document.getElementById('ft-ui').style.display='none';
            // Reset Positions
            Game.actors.forEach(a => {
                a.mesh.position.set((a.role-2)*5, 0, a.team==='home'?15:-15);
                a.vel.set(0,0,0);
            });
            // Ball to PG
            const pg = Game.actors.find(a => a.team === team && a.role === 0);
            Game.ball.owner = pg; Game.ball.state='dribble';
            showNotify("INBOUND");
        }

        function score(team) {
            Game.scores[team]+=2;
            updateHUD();
            resetInbound(team==='home'?'away':'home');
        }

        function showNotify(txt) {
            const el = document.getElementById('feedback');
            el.innerText = txt; el.classList.add('active');
            setTimeout(()=>el.classList.remove('active'), 1500);
        }

        function updateHUD() {
            document.getElementById('sc-h').innerText = Game.scores.home;
            document.getElementById('sc-a').innerText = Game.scores.away;
            document.getElementById('foul-h').innerText = "FLS: " + Game.fouls.home;
            document.getElementById('foul-a').innerText = "FLS: " + Game.fouls.away;
            if(Game.fouls.home >= 5) document.getElementById('foul-h').style.color = 'red';
            if(Game.fouls.away >= 5) document.getElementById('foul-a').style.color = 'red';
        }

    </script>
</body>
</html>
