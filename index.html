<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Intramural Scouting v7.0 (Coaching)</title>
    <style>
        :root { --blue: #3b82f6; --red: #ef4444; --dark: #0f172a; --panel: #18181b; --text: #f8fafc; }
        body { margin: 0; background: #000; color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; user-select: none; }
        
        /* UI LAYOUT */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; }
        .screen.active { display: flex; animation: fade 0.3s ease-out; }
        @keyframes fade { from {opacity:0} to {opacity:1} }

        /* MENU STYLES */
        #screen-menu { background: linear-gradient(135deg, #0f172a 0%, #000 100%); align-items: center; justify-content: center; }
        .hero-title { font-size: 60px; font-weight: 900; margin-bottom: 20px; text-align: center; text-transform: uppercase; letter-spacing: -2px; }
        .menu-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 15px 50px; font-size: 18px; font-weight: bold; margin: 10px; cursor: pointer; transition: 0.2s; width: 300px; text-transform: uppercase; }
        .menu-btn:hover { background: white; color: black; }
        .menu-btn.primary { background: var(--blue); border-color: var(--blue); }

        /* GM DASHBOARD */
        #screen-gm { background: #111; flex-direction: row; }
        .gm-sidebar { width: 280px; background: #0f1115; border-right: 1px solid #222; padding: 20px; display: flex; flex-direction: column; }
        .gm-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; gap: 30px; }
        .team-card { padding: 10px; background: #1f1f23; border: 1px solid #333; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .team-card:hover { border-color: #666; }
        .team-card.active { border-color: var(--blue); background: #252530; }
        .color-dot { width: 10px; height: 10px; border-radius: 50%; }
        
        /* EDITOR */
        .editor-panel { width: 450px; background: #18181b; padding: 20px; border-radius: 8px; border: 1px solid #333; display: none; }
        .editor-panel.active { display: block; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        label { display: block; font-size: 10px; color: #888; text-transform: uppercase; font-weight: bold; margin-bottom: 2px; }
        input[type=text], input[type=number] { background: #000; border: 1px solid #333; color: white; padding: 5px; width: 100%; box-sizing: border-box; }
        input[type=color] { width: 100%; height: 30px; border: none; background: none; }
        input[type=range] { width: 100%; accent-color: var(--blue); }

        /* GAME HUD */
        #screen-game { background: #000; }
        .hud-top { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 40px; background: rgba(0,0,0,0.8); padding: 10px 40px; border-radius: 10px; border-bottom: 3px solid var(--blue); z-index: 50; }
        .score-box { text-align: center; }
        .score-lbl { font-size: 10px; color: #aaa; font-weight: bold; }
        .score-num { font-size: 30px; font-weight: 900; font-family: monospace; line-height: 1; }
        .pause-btn { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; background: rgba(0,0,0,0.8); border: 1px solid #333; color: white; font-weight: bold; border-radius: 50%; cursor: pointer; z-index: 100; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        
        /* PAUSE MENU (UPDATED) */
        .pause-menu { position: absolute; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .pause-menu.active { display: flex; }
        .pm-tabs { display: flex; gap: 20px; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .pm-tab { color: #666; cursor: pointer; font-weight: bold; padding: 10px 20px; text-transform: uppercase; font-size: 14px; }
        .pm-tab:hover { color: white; }
        .pm-tab.active { color: var(--blue); border-bottom: 2px solid var(--blue); }
        .pm-content { width: 600px; height: 400px; }
        .pm-page { display: none; height: 100%; flex-direction: column; }
        .pm-page.active { display: flex; }

        /* COACHING STYLES */
        .coach-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; height: 100%; }
        .roster-col h3 { font-size: 12px; color: #888; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .roster-item { display: flex; justify-content: space-between; padding: 8px; background: #222; margin-bottom: 5px; cursor: pointer; border: 1px solid transparent; font-size: 13px; }
        .roster-item:hover { border-color: #555; }
        .roster-item.starter { border-left: 3px solid #10b981; }
        .roster-item.bench { border-left: 3px solid #f59e0b; opacity: 0.7; }
        .roster-item.selected { background: #3b82f6; color: white; border-color: white; opacity: 1; }
        
        .strat-btn { width: 100%; padding: 12px; background: #222; color: #aaa; border: 1px solid #333; margin-bottom: 8px; cursor: pointer; text-align: left; font-weight: bold; }
        .strat-btn:hover { color: white; background: #333; }
        .strat-btn.active { background: var(--blue); color: white; border-color: var(--blue); }

        .back-btn { position: absolute; top: 20px; left: 20px; background: none; border: none; color: #666; font-weight: bold; cursor: pointer; }
        .back-btn:hover { color: white; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.150.1/three.min.js"></script>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <div class="hero-title">INTRAMURAL<br><span style="color:var(--blue)">SCOUTING</span></div>
        <button class="menu-btn primary" onclick="nav('game')">PLAY 5v5</button>
        <button class="menu-btn" onclick="nav('gm')">LEAGUE EDITOR</button>
    </div>

    <div id="screen-gm" class="screen">
        <button class="back-btn" onclick="nav('menu')">‚Üê MENU</button>
        <div class="gm-sidebar" style="padding-top:60px">
            <div style="font-size:10px; color:#666; margin-bottom:10px; font-weight:bold;">TEAMS</div>
            <div id="team-list"></div>
            <button onclick="addTeam()" style="margin-top:10px; width:100%; background:#222; border:1px dashed #444; color:#888; padding:8px; cursor:pointer;">+ Add Team</button>
        </div>
        <div class="gm-content">
            <div id="roster-view" style="flex:1; display:none;">
                <h1 id="team-header" style="margin:0 0 20px 0;">Team</h1>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input type="text" id="ed-t-name" oninput="saveTeam()">
                    <input type="color" id="ed-t-col" oninput="saveTeam()" style="width:40px;">
                </div>
                <div id="player-list"></div>
                <button onclick="addPlayer()" style="margin-top:15px; background:var(--blue); color:white; border:none; padding:10px 20px; font-weight:bold; cursor:pointer;">+ Sign Player</button>
            </div>
            
            <div id="player-edit" class="editor-panel">
                <h2 style="margin-top:0; color:var(--blue);">Edit Attributes</h2>
                <div class="form-grid">
                    <div><label>Name</label><input type="text" id="p-name" oninput="savePlayer()"></div>
                    <div><label>#</label><input type="number" id="p-num" oninput="savePlayer()"></div>
                </div>
                <div class="form-grid">
                    <div><label>Height (in)</label><input type="number" id="p-h" oninput="savePlayer()"></div>
                    <div><label>Weight (lbs)</label><input type="number" id="p-w" oninput="savePlayer()"></div>
                </div>
                <div class="form-grid">
                    <div><label>Skin</label><input type="color" id="p-skin" oninput="savePlayer()"></div>
                    <div><label>Shoes</label><input type="color" id="p-shoe" oninput="savePlayer()"></div>
                </div>
                <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">
                    <label>Shooting</label><input type="range" id="p-sht" min="20" max="99" oninput="savePlayer()">
                    <label>Speed</label><input type="range" id="p-spd" min="20" max="99" oninput="savePlayer()">
                    <label>Defense</label><input type="range" id="p-def" min="20" max="99" oninput="savePlayer()">
                </div>
                <button onclick="deletePlayer()" style="margin-top:20px; background:#450a0a; color:#fca5a5; border:none; padding:8px; width:100%; cursor:pointer;">Cut From Team</button>
            </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="hud-top">
            <div class="score-box"><div class="score-lbl">HOME</div><div class="score-num" style="color:var(--blue)" id="sc-h">0</div></div>
            <div class="score-box"><div class="score-lbl">AWAY</div><div class="score-num" style="color:var(--red)" id="sc-a">0</div></div>
        </div>
        <button class="pause-btn" onclick="togglePause()">II</button>

        <div id="pause-menu" class="pause-menu">
            <div class="pm-tabs">
                <div class="pm-tab active" onclick="pmNav('main')">Main</div>
                <div class="pm-tab" onclick="pmNav('coach')">Coaching</div>
                <div class="pm-tab" onclick="pmNav('cam')">Camera</div>
            </div>

            <div class="pm-content">
                <div id="pm-main" class="pm-page active" style="align-items: center; justify-content: center;">
                    <h1 style="font-size:40px; margin-bottom:20px;">PAUSED</h1>
                    <button class="menu-btn primary" onclick="togglePause()">RESUME</button>
                    <button class="menu-btn" onclick="quitGame()">QUIT TO MENU</button>
                </div>

                <div id="pm-coach" class="pm-page">
                    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
                        <button class="tag-btn" onclick="setCoachTeam('home')" id="btn-team-h">HOME TEAM</button>
                        <button class="tag-btn" onclick="setCoachTeam('away')" id="btn-team-a">AWAY TEAM</button>
                    </div>
                    
                    <div class="coach-grid">
                        <div class="strat-col">
                            <h3>Defensive Set</h3>
                            <button class="strat-btn active" id="def-man" onclick="setDef('man')">Man-to-Man</button>
                            <button class="strat-btn" id="def-23" onclick="setDef('23')">2-3 Zone</button>
                            <button class="strat-btn" id="def-32" onclick="setDef('32')">3-2 Zone</button>
                            <p style="font-size:11px; color:#666; margin-top:10px;">Select a defensive scheme. Players will adjust positioning automatically on defense.</p>
                        </div>
                        <div class="roster-col">
                            <h3>Rotation (Click 2 to Swap)</h3>
                            <div id="pm-roster-list" style="overflow-y:auto; height:250px; padding-right:5px;"></div>
                        </div>
                    </div>
                </div>

                <div id="pm-cam" class="pm-page" style="align-items: center; justify-content: center;">
                    <button class="menu-btn" onclick="setCam('broadcast')">üì∫ Broadcast</button>
                    <button class="menu-btn" onclick="setCam('2k')">üèÄ 2K View</button>
                    <button class="menu-btn" onclick="setCam('sky')">ü¶Ö Skybox</button>
                    <button class="menu-btn" onclick="setCam('baseline')">üì∑ Baseline</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const DefP = { name:"New Player", num:0, h:69, w:160, skin:"#8d5524", shoes:"#fff", sht:60, spd:70, def:50 };
        // Generate 8 players (5 starters, 3 bench)
        const genRoster = (pf) => Array.from({length:8}).map((_,i) => ({...DefP, id:pf+i, name: pf+' Player '+(i+1), num:i, h:69+i, spd:70-i}));

        let DB = JSON.parse(localStorage.getItem('bball_v7')) || {
            teams: [
                {id:'t1', name:'Bruzz Squad', color:'#3b82f6', roster: genRoster('t1')},
                {id:'t2', name:'The Opps', color:'#ef4444', roster: genRoster('t2')}
            ]
        };
        
        let app = { screen:'menu', tId:null, pId:null, gameOn:false };
        let coach = { team:'home', swapA:null }; // Coaching state
        let game = { paused:false, def:{home:'man', away:'man'}, cam:'broadcast', activeRoster:{home:[0,1,2,3,4], away:[0,1,2,3,4]} }; // Indices of active players

        const save = () => localStorage.setItem('bball_v7', JSON.stringify(DB));
        const nav = (s) => {
            document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active'));
            document.getElementById('screen-'+s).classList.add('active');
            app.screen=s; if(s==='gm') renderGM(); if(s==='game') startGame(); else stopGame();
        };

        // --- PAUSE MENU LOGIC ---
        function togglePause() { 
            game.paused = !game.paused; 
            const m = document.getElementById('pause-menu');
            if(game.paused) { m.classList.add('active'); pmNav('main'); }
            else { m.classList.remove('active'); coach.swapA=null; }
        }
        function pmNav(tab) {
            document.querySelectorAll('.pm-page').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.pm-tab').forEach(e=>e.classList.remove('active'));
            document.getElementById('pm-'+tab).classList.add('active');
            // Hacky tab highlight logic
            const tabs = ['main','coach','cam'];
            document.querySelectorAll('.pm-tab')[tabs.indexOf(tab)].classList.add('active');
            if(tab==='coach') renderCoachUI();
        }
        function setCam(c) { game.cam = c; togglePause(); } // Auto close on cam switch
        function quitGame() { stopGame(); nav('menu'); }

        // --- COACHING LOGIC ---
        function setCoachTeam(side) { coach.team = side; renderCoachUI(); }
        
        function setDef(type) {
            game.def[coach.team] = type;
            renderCoachUI();
        }

        function renderCoachUI() {
            // Highlight Buttons
            document.getElementById('btn-team-h').style.opacity = coach.team==='home'?1:0.5;
            document.getElementById('btn-team-a').style.opacity = coach.team==='away'?1:0.5;
            
            ['man','23','32'].forEach(t => {
                const b = document.getElementById('def-'+t);
                if(game.def[coach.team] === t) b.classList.add('active'); else b.classList.remove('active');
            });

            // Render Roster List
            const list = document.getElementById('pm-roster-list'); list.innerHTML='';
            const tIdx = coach.team==='home' ? 0 : 1;
            const team = DB.teams[tIdx];
            const activeIndices = game.activeRoster[coach.team];

            team.roster.forEach((p, idx) => {
                const isStarter = activeIndices.includes(idx);
                const el = document.createElement('div');
                el.className = `roster-item ${isStarter ? 'starter' : 'bench'} ${coach.swapA === idx ? 'selected' : ''}`;
                el.innerHTML = `<span>#${p.num} ${p.name}</span> <span style="color:#666">${isStarter ? 'ON COURT' : 'BENCH'}</span>`;
                el.onclick = () => handleSub(idx);
                list.appendChild(el);
            });
        }

        function handleSub(idx) {
            if(coach.swapA === null) {
                coach.swapA = idx;
            } else {
                // Perform Swap in Game State
                const t = coach.team;
                const active = game.activeRoster[t];
                const A = coach.swapA; const B = idx;
                
                const aInGame = active.includes(A);
                const bInGame = active.includes(B);

                if(aInGame && !bInGame) {
                    // Swap A out, B in
                    game.activeRoster[t] = active.map(i => i===A ? B : i);
                    respawnTeam(t);
                } else if (!aInGame && bInGame) {
                    game.activeRoster[t] = active.map(i => i===B ? A : i);
                    respawnTeam(t);
                }
                // If both in or both out, do nothing
                coach.swapA = null;
            }
            renderCoachUI();
        }

        // --- GAME ENGINE ---
        let scene, camera, renderer, clock, actors=[], ball, scores={h:0,a:0};
        const keys={};

        function stopGame() { app.gameOn=false; if(document.querySelector('canvas')) document.querySelector('canvas').remove(); }
        function startGame() {
            if(DB.teams.length<2) return alert("Need 2 teams!");
            app.gameOn=true; scores={h:0,a:0}; game.paused=false;
            game.activeRoster = { home: [0,1,2,3,4], away: [0,1,2,3,4] }; // Reset starters
            document.getElementById('pause-menu').classList.remove('active');
            
            // 3D Setup
            scene = new THREE.Scene(); scene.background=new THREE.Color(0x111); scene.fog=new THREE.Fog(0x111,40,150);
            camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('screen-game').appendChild(renderer.domElement);
            clock = new THREE.Clock();

            // Light & Court
            scene.add(new THREE.AmbientLight(0xffffff,0.6));
            const l=new THREE.DirectionalLight(0xffffff,1); l.position.set(20,80,40); l.castShadow=true; scene.add(l);
            const fl=new THREE.Mesh(new THREE.PlaneGeometry(200,200), new THREE.MeshStandardMaterial({color:0x222})); fl.rotation.x=-Math.PI/2; fl.position.y=-0.1; scene.add(fl);
            
            // Texture
            const cvs=document.createElement('canvas'); cvs.width=1024; cvs.height=2048; const ctx=cvs.getContext('2d');
            ctx.fillStyle='#d2a679'; ctx.fillRect(0,0,1024,2048); ctx.fillStyle='#1e3a8a'; ctx.fillRect(362,0,300,380); ctx.fillRect(362,1668,300,380);
            ctx.strokeStyle='white'; ctx.lineWidth=20; ctx.strokeRect(50,50,924,1948);
            const tex=new THREE.CanvasTexture(cvs); tex.anisotropy=16;
            const court=new THREE.Mesh(new THREE.PlaneGeometry(50,94), new THREE.MeshStandardMaterial({map:tex})); court.rotation.x=-Math.PI/2; scene.add(court);

            // Hoops
            const mkHoop=(z,r)=>{
                const g=new THREE.Group();
                const p=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,14), new THREE.MeshStandardMaterial({color:0x333})); p.position.y=7; g.add(p);
                const b=new THREE.Mesh(new THREE.BoxGeometry(6,4,0.2), new THREE.MeshStandardMaterial({color:0xffffff,opacity:0.9,transparent:true})); b.position.set(0,13,1.5); g.add(b);
                const rm=new THREE.Mesh(new THREE.TorusGeometry(1.5,0.1,16,16), new THREE.MeshStandardMaterial({color:'orange'})); rm.position.set(0,11,3); rm.rotation.x=Math.PI/2; g.add(rm);
                g.position.z=z; g.rotation.y=r; scene.add(g);
            };
            mkHoop(-47,0); mkHoop(47,Math.PI);

            ball = { mesh: new THREE.Mesh(new THREE.SphereGeometry(0.7), new THREE.MeshStandardMaterial({color:'orange'})), pos: new THREE.Vector3(), vel: new THREE.Vector3(), owner:null, state:'free' };
            scene.add(ball.mesh);

            // Initial Spawn
            actors = [];
            respawnTeam('home');
            respawnTeam('away');
            
            // Give ball to first player
            ball.owner = actors[0]; ball.state='dribble';

            animate();
        }

        // --- SUB SYSTEM ---
        function respawnTeam(side) {
            // Remove existing meshes for this team
            for(let i=actors.length-1; i>=0; i--) {
                if(actors[i].team === side) {
                    scene.remove(actors[i].mesh);
                    actors.splice(i, 1);
                }
            }

            const teamIdx = side==='home'?0:1;
            const team = DB.teams[teamIdx];
            const activeIndices = game.activeRoster[side];

            activeIndices.forEach((rosterIdx, i) => {
                const p = team.roster[rosterIdx];
                const g = new THREE.Group();
                const s = p.h/75; const w=1+((p.w-160)/300); g.scale.set(s,s,s);
                const matJ = new THREE.MeshStandardMaterial({color:team.color});
                const matS = new THREE.MeshStandardMaterial({color:p.skin});

                const torso = new THREE.Mesh(new THREE.BoxGeometry(1.5*w,2.5,0.8*w), matJ); torso.position.y=4.25; g.add(torso);
                const head = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.9,0.8), matS); head.position.y=6; g.add(head);
                
                const mkL=(x)=> {const m=new THREE.Mesh(new THREE.BoxGeometry(0.5*w,2,0.5*w), matS); m.position.set(x,1,0); return m;};
                const lL=mkL(-0.5*w); const lR=mkL(0.5*w); g.add(lL); g.add(lR);
                const mkA=(x)=> {const m=new THREE.Mesh(new THREE.BoxGeometry(0.3*w,2.5,0.3*w), matS); m.position.set(x,4.5,0); return m;};
                const aL=mkA(-1.1*w); const aR=mkA(1.1*w); g.add(aL); g.add(aR);

                let z = side==='home' ? 15 : -15; let x = (i-2)*8;
                g.position.set(x,0,z);
                scene.add(g);
                
                actors.push({ mesh:g, p:p, team:side, idx:i, limbs:{lL,lR,aL,aR}, cooldown:0 });
            });
        }

        // --- GAME LOOP ---
        window.onkeydown=e=>{ if(e.key==='Escape')togglePause(); if(game.paused)return; 
            if(e.key.startsWith('Arrow')) keys[e.key]=true; if(e.key==='Shift') keys.shift=true; if(e.code==='Space') keys.space=true;
        };
        window.onkeyup=e=>{ 
            if(e.key.startsWith('Arrow')) keys[e.key]=false; if(e.key==='Shift') keys.shift=false; 
            if(e.code==='Space') { keys.space=false; shoot(); }
        };

        function shoot() {
            const u = actors.find(a=>a.team==='home' && a.idx===0); // User is always index 0 of home currently
            if(ball.owner!==u) return;
            ball.owner=null; ball.state='air';
            const hz = u.mesh.position.z>0?41:-41;
            const err = (100-u.p.sht)*0.005;
            ball.vel.set((0-u.mesh.position.x)/40 + (Math.random()-.5)*err, 1.2, (hz-u.mesh.position.z)/40);
        }

        function animate() {
            if(!app.gameOn) return;
            requestAnimationFrame(animate);
            if(game.paused) return;
            const dt = clock.getDelta();

            // 1. User
            const user = actors.find(a=>a.team==='home' && a.idx===0);
            if(user) {
                const s = (keys.Shift?15:8)*dt;
                if(keys.ArrowUp) user.mesh.position.z-=s; if(keys.ArrowDown) user.mesh.position.z+=s;
                if(keys.ArrowLeft) user.mesh.position.x-=s; if(keys.ArrowRight) user.mesh.position.x+=s;
                
                // Camera
                if(game.cam==='broadcast') { camera.position.set(0,50,70); camera.lookAt(0,0,0); }
                else if(game.cam==='2k') { 
                    camera.position.x += (user.mesh.position.x - camera.position.x)*0.1;
                    camera.position.z += ((user.mesh.position.z+25) - camera.position.z)*0.1;
                    camera.position.y = 20; camera.lookAt(user.mesh.position.x, 0, user.mesh.position.z-20);
                }
                else if(game.cam==='sky') { camera.position.set(0,90,1); camera.lookAt(0,0,0); }
                else { camera.position.set(0,5,50); camera.lookAt(user.mesh.position); }
            }

            // 2. Ball
            if(ball.owner) {
                ball.mesh.position.copy(ball.owner.mesh.position);
                ball.mesh.position.y=3 + Math.abs(Math.sin(Date.now()*0.015))*3;
                ball.mesh.position.z+=1.5;
            } else {
                ball.mesh.position.add(ball.vel); ball.vel.y-=0.03;
                if(ball.mesh.position.y<0.7) { ball.mesh.position.y=0.7; ball.vel.y*=-0.7; }
                // Score
                if(Math.abs(ball.mesh.position.z)>40 && Math.abs(ball.mesh.position.x)<2 && ball.mesh.position.y>10 && ball.vel.y<0) {
                    scores.h+=2; document.getElementById('sc-h').innerText=scores.h; ball.vel.set(0,0,0); ball.owner=user;
                }
                // Catch
                actors.forEach(a=>{
                    if(a.mesh.position.distanceTo(ball.mesh.position)<2.5) { ball.owner=a; ball.state='dribble'; }
                });
            }

            // 3. AI (DEFENSIVE SETS)
            actors.forEach(a=>{
                if(a===user) return;
                
                if(a.team !== (ball.owner?ball.owner.team:'home')) {
                    // DEFENSE LOGIC
                    const set = game.def[a.team]; // 'man', '23', '32'
                    let tx=a.mesh.position.x, tz=a.mesh.position.z;

                    if(set === 'man') {
                        // Guard mirroring index on other team? Simple logic: guard ball
                        tx = (ball.mesh.position.x + 0)*0.5; 
                        tz = (ball.mesh.position.z + (a.team==='home'?-41:41))*0.5;
                    } else if(set === '23') {
                        // 2 High, 3 Low
                        const hz = a.team==='home'?-25:25;
                        if(a.idx < 2) { tx = (a.idx===0?-10:10); tz = hz + (a.team==='home'?10:-10); } // Guards
                        else { tx = (a.idx-3)*15; tz = hz; } // Forwards
                    } else if(set === '32') {
                        const hz = a.team==='home'?-25:25;
                        if(a.idx < 3) { tx = (a.idx-1)*15; tz = hz + (a.team==='home'?10:-10); }
                        else { tx = (a.idx===3?-10:10); tz = hz; }
                    }

                    // Lerp to target
                    a.mesh.position.x += (tx - a.mesh.position.x)*0.02;
                    a.mesh.position.z += (tz - a.mesh.position.z)*0.02;
                }
                
                // Walk anim
                a.limbs.lL.rotation.x = Math.sin(Date.now()*0.01 + a.mesh.position.x);
                a.limbs.lR.rotation.x = Math.cos(Date.now()*0.01 + a.mesh.position.x);
            });

            renderer.render(scene, camera);
        }

        // Editor Logic Helpers
        window.saveTeam=()=>{const t=DB.teams.find(x=>x.id===app.tId); t.name=document.getElementById('ed-t-name').value; t.color=document.getElementById('ed-t-col').value; save(); renderGM();}
        window.savePlayer=()=>{
            const t=DB.teams.find(x=>x.id===app.tId); const p=t.roster.find(x=>x.id===app.pId);
            p.name=document.getElementById('p-name').value; p.num=document.getElementById('p-num').value;
            p.h=parseInt(document.getElementById('p-h').value); p.w=parseInt(document.getElementById('p-w').value);
            p.skin=document.getElementById('p-skin').value; p.shoes=document.getElementById('p-shoe').value;
            p.sht=parseInt(document.getElementById('p-sht').value); p.spd=parseInt(document.getElementById('p-spd').value); p.def=parseInt(document.getElementById('p-def').value);
            save(); renderRoster(); renderEditor();
        }
        window.addTeam=()=>{DB.teams.push({id:'t'+Date.now(), name:'New Team', color:'#fff', roster:genRoster('t'+Date.now())}); save(); renderGM();}
        window.addPlayer=()=>{const t=DB.teams.find(x=>x.id===app.tId); t.roster.push({...DefP, id:'p'+Date.now()}); save(); renderRoster();}
        window.deletePlayer=()=>{const t=DB.teams.find(x=>x.id===app.tId); t.roster=t.roster.filter(p=>p.id!==app.pId); app.pId=null; document.getElementById('player-edit').classList.remove('active'); save(); renderRoster();}

    </script>
</body>
</html>
