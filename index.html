<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Basketball Scouting Game</title>
    <style>
        :root { --blue: #3b82f6; --red: #ef4444; --dark: #0f172a; --panel: #18181b; --text: #f8fafc; --accent: #8b5cf6; }
        body { margin: 0; background: #000; color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; user-select: none; }
        
        /* --- SCREENS --- */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; }
        .screen.active { display: flex; animation: fade 0.3s ease-out; }
        @keyframes fade { from {opacity:0} to {opacity:1} }

        /* --- 1. MAIN MENU --- */
        #screen-menu { 
            background: linear-gradient(135deg, #0f172a 0%, #000000 100%); 
            align-items: center; justify-content: center;
        }
        .hero-title { font-size: 60px; font-weight: 900; letter-spacing: -1px; line-height: 1; margin-bottom: 15px; text-shadow: 0 0 40px rgba(59, 130, 246, 0.4); text-transform: uppercase; text-align: center; }
        .hero-subtitle { color: #64748b; font-size: 14px; letter-spacing: 4px; margin-bottom: 60px; font-weight: 700; }
        
        .menu-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.1); 
            color: white; padding: 15px 60px; font-size: 16px; font-weight: 700; 
            margin: 10px; cursor: pointer; transition: 0.2s; width: 320px; text-align: center;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .menu-btn:hover { background: white; color: black; transform: scale(1.05); }
        .menu-btn.primary { background: var(--blue); border-color: var(--blue); }
        .menu-btn.primary:hover { background: #2563eb; color: white; }

        /* --- 2. GM DASHBOARD --- */
        #screen-gm { background: #111; flex-direction: row; }
        
        /* Sidebar */
        .gm-sidebar { width: 280px; background: #0f1115; border-right: 1px solid #222; padding: 20px; display: flex; flex-direction: column; }
        .gm-header { font-size: 11px; font-weight: bold; color: #555; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        
        .team-card { 
            padding: 12px; background: #18181b; border: 1px solid #222; margin-bottom: 8px; 
            cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 10px; transition: 0.2s;
        }
        .team-card:hover { background: #27272a; border-color: #444; }
        .team-card.active { border-color: var(--blue); background: #1e293b; }
        .color-dot { width: 10px; height: 10px; border-radius: 50%; }

        /* Content Area */
        .gm-content { flex: 1; padding: 40px; overflow-y: auto; display: flex; gap: 40px; position: relative; }
        
        /* Roster View */
        .roster-panel { flex: 1; max-width: 500px; }
        .player-row { 
            display: flex; justify-content: space-between; padding: 12px; 
            border-bottom: 1px solid #222; cursor: pointer; color: #94a3b8; font-size: 13px;
        }
        .player-row:hover { background: #1a1a1a; color: white; }
        .player-row.active { color: var(--blue); font-weight: bold; background: #1e293b; border-radius: 4px; border-bottom: none; }
        
        /* EDITOR PANEL (New & Expanded) */
        .editor-panel { 
            width: 500px; background: #18181b; padding: 30px; border-radius: 12px; 
            border: 1px solid #333; height: fit-content; display: none; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .editor-panel.active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from {opacity:0; transform: translateY(20px);} to {opacity:1; transform:none;} }
        
        .section-title { font-size: 12px; color: var(--accent); font-weight: bold; text-transform: uppercase; margin: 20px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }

        .control { margin-bottom: 5px; }
        label { display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-bottom: 4px; text-transform: uppercase; font-weight: bold; }
        
        input[type=text], input[type=number] { 
            background: #09090b; border: 1px solid #333; color: white; padding: 8px; width: 100%; border-radius: 4px; box-sizing: border-box; font-family: monospace;
        }
        input[type=color] { width: 100%; height: 35px; background: none; border: none; cursor: pointer; }
        
        /* Custom Sliders */
        input[type=range] { width: 100%; height: 4px; background: #333; border-radius: 2px; -webkit-appearance: none; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--blue); border-radius: 50%; margin-top: -4px; }
        
        /* Stats Blocks */
        .stat-block { background: #222; padding: 8px; border-radius: 4px; text-align: center; }
        .stat-block label { justify-content: center; margin-bottom: 5px; color: #888; }
        .stat-val { font-size: 14px; font-weight: bold; color: white; display: block; margin-bottom: 5px; }

        /* --- 3. GAME UI --- */
        #screen-game { background: #000; }
        .scoreboard { 
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            display: flex; background: #111; padding: 10px 40px; border-radius: 0 0 12px 12px; gap: 40px;
            border-bottom: 4px solid var(--blue); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .score-val { font-size: 32px; font-weight: 800; font-family: monospace; }
        .pause-menu {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; flex-direction: column; pointer-events: auto; z-index: 100;
        }
        .pause-menu.active { display: flex; }
        .back-btn { position: absolute; top: 20px; left: 20px; cursor: pointer; font-weight: bold; color: #666; font-size: 12px; background: none; border: none; text-transform: uppercase; }
        .back-btn:hover { color: white; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.150.1/three.min.js"></script>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <div class="hero-title">BASKETBALL<br><span style="color:var(--blue)">SCOUTING GAME</span></div>
        <div class="hero-subtitle">GM MODE • STRATEGY • SIMULATION</div>
        <button class="menu-btn primary" onclick="nav('gm')">GM Dashboard</button>
        <button class="menu-btn" onclick="startMatchup()">Play Now</button>
        <button class="menu-btn" onclick="alert('Settings Saved')">Settings</button>
    </div>

    <div id="screen-gm" class="screen">
        <button class="back-btn" onclick="nav('menu')">← Main Menu</button>
        
        <div class="gm-sidebar" style="padding-top: 60px;">
            <div class="gm-header">League Teams</div>
            <div id="team-list-container"></div>
            <button onclick="addTeam()" style="margin-top:10px; width:100%; background: #222; border: 1px dashed #444; color: #888; padding: 10px; cursor: pointer; font-size:12px;">+ Create Expansion Team</button>
        </div>

        <div class="gm-content">
            <div class="roster-panel" id="roster-view" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h1 id="team-title" style="margin:0; font-size: 24px; font-weight:900; letter-spacing:-1px;">Team Name</h1>
                    <div style="display:flex; gap:5px;">
                        <input type="color" id="team-col-picker" style="width:30px; height:30px; border-radius:4px;" oninput="updateTeamMeta()">
                        <button onclick="deleteTeam()" style="background:#ef4444; color:white; border:none; padding:0 10px; border-radius:4px; font-weight:bold; cursor:pointer;">X</button>
                    </div>
                </div>
                <input type="text" id="team-name-edit" oninput="updateTeamMeta()" placeholder="Edit Team Name..." style="margin-bottom:20px;">

                <div class="gm-header">Active Roster</div>
                <div id="roster-list"></div>
                <button onclick="addPlayer()" style="margin-top:15px; width:100%; background:var(--blue); color:white; border:none; padding:12px; cursor:pointer; font-weight:bold; border-radius:4px;">+ Sign New Player</button>
            </div>

            <div class="editor-panel" id="player-editor">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0; font-size:18px; color:white;">Edit Player</h2>
                    <button onclick="deletePlayer()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:11px; font-weight:bold;">CUT PLAYER</button>
                </div>
                
                <div class="form-grid">
                    <div class="control"><label>Name</label><input type="text" id="ed-name" oninput="savePlayer()"></div>
                    <div class="control"><label>Number</label><input type="number" id="ed-num" oninput="savePlayer()"></div>
                </div>

                <div class="section-title">Body & Appearance</div>
                <div class="form-grid">
                    <div class="control"><label>Height (in)</label><input type="number" id="ed-h" oninput="savePlayer()"></div>
                    <div class="control"><label>Weight (lbs)</label><input type="range" id="ed-w" min="0" max="100" oninput="savePlayer()"></div>
                </div>
                <div class="form-grid">
                    <div class="control"><label>Skin Tone</label><input type="color" id="ed-skin" oninput="savePlayer()"></div>
                    <div class="control"><label>Hair Color</label><input type="color" id="ed-hair" oninput="savePlayer()"></div>
                </div>
                <div class="form-grid">
                    <div class="control"><label>Shoe Color</label><input type="color" id="ed-shoe" oninput="savePlayer()"></div>
                    <div class="control">
                        <label>Headband</label>
                        <div style="display:flex; gap:5px;">
                            <input type="checkbox" id="ed-acc-tog" onchange="savePlayer()" style="width:20px; height:20px;">
                            <input type="color" id="ed-acc-col" oninput="savePlayer()" style="flex:1;">
                        </div>
                    </div>
                </div>

                <div class="section-title">Offensive Attributes</div>
                <div class="stat-grid">
                    <div class="stat-block"><label>Layup</label><span class="stat-val" id="val-layup">70</span><input type="range" id="st-layup" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>Dunk</label><span class="stat-val" id="val-dunk">50</span><input type="range" id="st-dunk" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>Mid</label><span class="stat-val" id="val-mid">60</span><input type="range" id="st-mid" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>3PT</label><span class="stat-val" id="val-3pt">60</span><input type="range" id="st-3pt" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>Pass</label><span class="stat-val" id="val-pass">60</span><input type="range" id="st-pass" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>Handle</label><span class="stat-val" id="val-handle">60</span><input type="range" id="st-handle" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>O-Reb</label><span class="stat-val" id="val-oreb">50</span><input type="range" id="st-oreb" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>FT</label><span class="stat-val" id="val-ft">70</span><input type="range" id="st-ft" min="25" max="99" oninput="savePlayer()"></div>
                </div>

                <div class="section-title">Defensive & Physical</div>
                <div class="stat-grid">
                    <div class="stat-block"><label>Int Def</label><span class="stat-val" id="val-intdef">50</span><input type="range" id="st-intdef" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>Per Def</label><span class="stat-val" id="val-perdef">50</span><input type="range" id="st-perdef" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>Steal</label><span class="stat-val" id="val-steal">50</span><input type="range" id="st-steal" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>Block</label><span class="stat-val" id="val-block">50</span><input type="range" id="st-block" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>Speed</label><span class="stat-val" id="val-speed">70</span><input type="range" id="st-speed" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>Str</label><span class="stat-val" id="val-str">50</span><input type="range" id="st-str" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>Vert</label><span class="stat-val" id="val-vert">70</span><input type="range" id="st-vert" min="25" max="99" oninput="savePlayer()"></div>
                    <div class="stat-block"><label>Stam</label><span class="stat-val" id="val-stam">80</span><input type="range" id="st-stam" min="25" max="99" oninput="savePlayer()"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-ui" style="position:absolute; inset:0; pointer-events:none;">
            <div class="scoreboard">
                <div class="score-team"><div style="font-size:10px; color:#888; font-weight:bold;">HOME</div><div class="score-val" style="color:var(--blue)" id="score-h">00</div></div>
                <div class="score-team"><div style="font-size:10px; color:#888; font-weight:bold;">AWAY</div><div class="score-val" style="color:var(--red)" id="score-a">00</div></div>
            </div>
        </div>
        <div id="pause-menu" class="pause-menu">
            <h1 style="font-size:40px; margin-bottom:20px; font-weight:900;">PAUSED</h1>
            <button class="menu-btn" onclick="togglePause()">Resume</button>
            <button class="menu-btn" onclick="quitGame()">Quit to Menu</button>
        </div>
    </div>

    <script>
        // --- 1. DATA ---
        const NEW_P = { 
            name:"Rookie", num:0, h:75, w:50, skin:"#8d5524", hair:"#111111", shoes:"#ffffff", 
            acc:{has:false, col:"#ffffff"},
            stats:{
                layup:70, dunk:50, mid:60, pt3:60, pass:60, handle:60, oreb:50, ft:70,
                intdef:50, perdef:50, steal:50, block:50, speed:70, str:50, vert:70, stam:80
            }
        };

        let DB = JSON.parse(localStorage.getItem('bruzz_v5')) || {
            teams: [
                {id:'t1', name:'The Bruzz', color:'#3b82f6', roster:[{...NEW_P, id:'p1', name:'My Player', stats:{...NEW_P.stats, speed:90, pt3:85}}]},
                {id:'t2', name:'Varsity', color:'#ef4444', roster:[{...NEW_P, id:'p2', name:'Rival', num:23, stats:{...NEW_P.stats, speed:85}}]}
            ]
        };

        let app = { screen:'menu', activeT:null, activeP:null, gameOn:false };
        let engine = { scene:null, paused:false, rigs:[] };

        const save = () => localStorage.setItem('bruzz_v5', JSON.stringify(DB));
        const nav = (s) => {
            document.querySelectorAll('.screen').forEach(el=>el.classList.remove('active'));
            document.getElementById('screen-'+s).classList.add('active');
            app.screen=s; if(s==='gm') renderGM();
        };

        // --- 2. GM LOGIC ---
        function renderGM() {
            const list = document.getElementById('team-list-container'); list.innerHTML='';
            DB.teams.forEach(t => {
                const el = document.createElement('div');
                el.className = `team-card ${app.activeT===t.id?'active':''}`;
                el.innerHTML = `<div class="color-dot" style="background:${t.color}"></div><span>${t.name}</span>`;
                el.onclick = () => { app.activeT=t.id; renderGM(); loadRoster(); };
                list.appendChild(el);
            });
        }

        function loadRoster() {
            const t = DB.teams.find(x=>x.id===app.activeT); if(!t) return;
            document.getElementById('roster-view').style.display='block';
            document.getElementById('team-title').innerText = t.name;
            document.getElementById('team-name-edit').value = t.name;
            document.getElementById('team-col-picker').value = t.color;
            
            const list = document.getElementById('roster-list'); list.innerHTML='';
            t.roster.forEach(p => {
                const el = document.createElement('div');
                el.className = `player-row ${app.activeP===p.id?'active':''}`;
                el.innerHTML = `<span>#${p.num} ${p.name}</span> <span>${Math.floor(p.h/12)}'${p.h%12}"</span>`;
                el.onclick = () => { app.activeP=p.id; loadRoster(); loadEditor(); };
                list.appendChild(el);
            });
        }

        function loadEditor() {
            const t = DB.teams.find(x=>x.id===app.activeT);
            const p = t.roster.find(x=>x.id===app.activeP);
            if(!p.stats) p.stats = {...NEW_P.stats}; // migration safety
            if(!p.acc) p.acc = {has:false, col:"#ffffff"};

            document.getElementById('player-editor').classList.add('active');
            
            // Basic
            setVal('ed-name', p.name); setVal('ed-num', p.num);
            setVal('ed-h', p.h); setVal('ed-w', p.w || 50);
            setVal('ed-skin', p.skin); setVal('ed-hair', p.hair || '#111111'); setVal('ed-shoe', p.shoes);
            
            // Acc
            document.getElementById('ed-acc-tog').checked = p.acc.has;
            setVal('ed-acc-col', p.acc.col);

            // Stats loop
            for(const [k,v] of Object.entries(p.stats)) {
                if(document.getElementById('st-'+k)) {
                    setVal('st-'+k, v); document.getElementById('val-'+k).innerText = v;
                }
            }
        }

        function savePlayer() {
            const t = DB.teams.find(x=>x.id===app.activeT);
            const p = t.roster.find(x=>x.id===app.activeP);
            
            p.name = getVal('ed-name'); p.num=parseInt(getVal('ed-num'));
            p.h = parseInt(getVal('ed-h')); p.w = parseInt(getVal('ed-w'));
            p.skin = getVal('ed-skin'); p.hair = getVal('ed-hair'); p.shoes = getVal('ed-shoe');
            
            p.acc.has = document.getElementById('ed-acc-tog').checked;
            p.acc.col = getVal('ed-acc-col');

            for(const k of Object.keys(p.stats)) {
                if(document.getElementById('st-'+k)) {
                    p.stats[k] = parseInt(getVal('st-'+k));
                    document.getElementById('val-'+k).innerText = p.stats[k];
                }
            }
            save(); loadRoster();
        }

        function updateTeamMeta() {
            const t = DB.teams.find(x=>x.id===app.activeT);
            t.name = getVal('team-name-edit'); t.color = getVal('team-col-picker');
            document.getElementById('team-title').innerText = t.name;
            save(); renderGM();
        }

        const addTeam = () => { DB.teams.push({id:'t'+Date.now(), name:'New Team', color:'#fff', roster:[]}); save(); renderGM(); };
        const deleteTeam = () => { DB.teams=DB.teams.filter(t=>t.id!==app.activeT); app.activeT=null; document.getElementById('roster-view').style.display='none'; save(); renderGM(); };
        const addPlayer = () => { 
            const t = DB.teams.find(x=>x.id===app.activeT); 
            t.roster.push({...NEW_P, id:'p'+Date.now(), stats:{...NEW_P.stats}, acc:{...NEW_P.acc}}); 
            save(); loadRoster(); 
        };
        const deletePlayer = () => {
            const t = DB.teams.find(x=>x.id===app.activeT);
            t.roster = t.roster.filter(p=>p.id!==app.activeP); app.activeP=null;
            document.getElementById('player-editor').classList.remove('active'); save(); loadRoster();
        };

        const setVal = (id,v) => document.getElementById(id).value = v;
        const getVal = (id) => document.getElementById(id).value;

        // --- 3. GAME ENGINE ---
        function startMatchup() {
            if(DB.teams.length<2) return alert("Create at least 2 teams!");
            nav('game'); initGame(DB.teams[0], DB.teams[1]);
        }
        function quitGame() { app.gameOn=false; document.querySelector('canvas').remove(); nav('menu'); }
        function togglePause() { engine.paused=!engine.paused; document.getElementById('pause-menu').classList.toggle('active'); }

        function initGame(home, away) {
            app.gameOn=true; engine.paused=false;
            const scene = new THREE.Scene(); scene.background=new THREE.Color(0x050505); scene.fog=new THREE.Fog(0x050505,30,120);
            const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight,0.1,1000);
            camera.position.set(0,40,60); camera.lookAt(0,0,0);
            const renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth,window.innerHeight); renderer.shadowMap.enabled=true;
            document.getElementById('screen-game').appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff,0.6));
            const spot = new THREE.SpotLight(0xffffff,1.2); spot.position.set(20,80,40); spot.castShadow=true; spot.shadow.mapSize.set(2048,2048); scene.add(spot);

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(100,100), new THREE.MeshStandardMaterial({color:0x222}));
            floor.rotation.x=-Math.PI/2; floor.position.y=-0.1; scene.add(floor);
            
            const cvs = document.createElement('canvas'); cvs.width=1024; cvs.height=2048; const ctx=cvs.getContext('2d');
            ctx.fillStyle='#cea07e'; ctx.fillRect(0,0,1024,2048);
            ctx.fillStyle='rgba(0,0,0,0.05)'; for(let i=0;i<2048;i+=10) ctx.fillRect(0,i,1024,2);
            ctx.fillStyle='#1e3a8a'; ctx.fillRect(362,0,300,380);
            ctx.strokeStyle='white'; ctx.lineWidth=15; ctx.strokeRect(50,50,924,1948); ctx.beginPath(); ctx.arc(512,140,400,0,Math.PI); ctx.stroke();
            const tex=new THREE.CanvasTexture(cvs); tex.anisotropy=16;
            const court = new THREE.Mesh(new THREE.PlaneGeometry(50,94), new THREE.MeshStandardMaterial({map:tex}));
            court.rotation.x=-Math.PI/2; court.receiveShadow=true; scene.add(court);

            const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,14), new THREE.MeshStandardMaterial({color:0x222}));
            pole.position.set(0,7,-44); scene.add(pole);
            const rim = new THREE.Mesh(new THREE.TorusGeometry(1.5,0.1,16,16), new THREE.MeshStandardMaterial({color:'orange'}));
            rim.rotation.x=Math.PI/2; rim.position.set(0,11,-41); scene.add(rim);

            engine.rigs = [];
            const spawn = (p, col, side) => {
                const grp = new THREE.Group();
                const s = p.h/75; grp.scale.set(s,s,s);
                const w = 1 + (p.w? (p.w-50)/150 : 0); // Weight scaling width
                
                const matJ = new THREE.MeshStandardMaterial({color:col});
                const matS = new THREE.MeshStandardMaterial({color:p.skin});
                const matH = new THREE.MeshStandardMaterial({color:p.hair || '#111'});

                const torso = new THREE.Mesh(new THREE.BoxGeometry(1.5*w,2.4,0.8*w), matJ); torso.position.y=3.8; torso.castShadow=true; grp.add(torso);
                const head = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.9,0.9), matS); head.position.y=5.5; head.castShadow=true; grp.add(head);
                
                // Hair (Top of head)
                const hair = new THREE.Mesh(new THREE.BoxGeometry(0.82,0.2,0.92), matH); hair.position.y=6.0; grp.add(hair);

                // Headband
                if(p.acc && p.acc.has) {
                    const hb = new THREE.Mesh(new THREE.TorusGeometry(0.5, 0.08, 8, 16), new THREE.MeshStandardMaterial({color:p.acc.col}));
                    hb.rotation.x = Math.PI/2; hb.position.y = 5.8; hb.scale.set(1,1.2,1); grp.add(hb);
                }

                const legL = new THREE.Mesh(new THREE.BoxGeometry(0.5*w,2,0.5*w), matJ); legL.position.set(-0.5*w,1,0); grp.add(legL);
                const legR = new THREE.Mesh(new THREE.BoxGeometry(0.5*w,2,0.5*w), matJ); legR.position.set(0.5*w,1,0); grp.add(legR);
                
                grp.position.set((Math.random()-0.5)*20, 0, side==='home'?10:-10);
                scene.add(grp);
                engine.rigs.push({mesh:grp, p:p, limbs:{legL, legR}});
            };
            home.roster.forEach(p=>spawn(p, home.color, 'home'));
            away.roster.forEach(p=>spawn(p, away.color, 'away'));

            const keys={}; window.onkeydown=e=>{if(e.key==='Escape')togglePause();keys[e.key.toLowerCase()]=true;}; window.onkeyup=e=>keys[e.key.toLowerCase()]=false;
            const clock = new THREE.Clock();

            function loop() {
                if(!app.gameOn) return;
                requestAnimationFrame(loop);
                if(engine.paused) return;
                const dt = clock.getDelta();
                const t = Date.now()*0.001;

                if(engine.rigs.length>0) {
                    const u = engine.rigs[0];
                    const spd = (u.p.stats.speed/8)*dt;
                    if(keys.w) u.mesh.position.z-=spd; if(keys.s) u.mesh.position.z+=spd;
                    if(keys.a) u.mesh.position.x-=spd; if(keys.d) u.mesh.position.x+=spd;
                    camera.position.x+=(20+u.mesh.position.x*0.3 - camera.position.x)*0.1;
                    camera.position.z+=(u.mesh.position.z*0.1 - camera.position.z)*0.1;
                    camera.lookAt(u.mesh.position.x,0,u.mesh.position.z);
                }

                engine.rigs.forEach(r=>{
                    r.limbs.legL.rotation.x = Math.sin(t*10 + r.mesh.position.x);
                    r.limbs.legR.rotation.x = Math.cos(t*10 + r.mesh.position.x);
                });
                renderer.render(scene, camera);
            }
            loop();
        }
    </script>
</body>
</html>
